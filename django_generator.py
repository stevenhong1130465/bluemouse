import re
from typing import Dict, List, Any


def sanitize_class_name(name: str) -> str:
    """Sanitize name to valid Python class name (CamelCase)"""
    # Remove "ç³»çµ±", "æ¨¡çµ„" and non-alphanumeric chars
    clean_name = name.replace('ç³»çµ±', '').replace('æ¨¡çµ„', '')
    # Convert to Title Case and remove spaces/special chars
    clean_name = re.sub(r'[^a-zA-Z0-9]', ' ', clean_name).title().replace(' ', '')
    # Ensure it doesn't start with a number
    if clean_name and clean_name[0].isdigit():
        clean_name = 'Model' + clean_name
    return clean_name or 'Default'


def generate_django_code(
    module: Dict[str, Any],
    answers: List[int]
) -> Dict[str, Any]:
    """ç”Ÿæˆ Django ä»£ç¢¼"""
    # è§£æç”¨æˆ¶å›ç­”
    features = parse_user_answers(module, answers)
    
    # ç”Ÿæˆå®‰è£èªªæ˜ (å…ˆç”Ÿæˆï¼Œå› ç‚ºè¦æ”¾å…¥README)
    setup_instructions = generate_django_setup_instructions()

    # ç”Ÿæˆå„å€‹æ–‡ä»¶
    files = {
        "models.py": generate_django_models(module, features),
        "views.py": generate_django_views(module, features),
        "serializers.py": generate_django_serializers(module, features),
        "urls.py": generate_django_urls(module, features),
        "requirements.txt": generate_django_requirements(features),
        "admin.py": generate_django_admin(module, features),
        "tests.py": generate_django_tests(module, features),
        "README.md": setup_instructions  # Include README in files dict
    }
    
    return {
        "files": files,
        "setup_instructions": setup_instructions,
        "framework": "Django",
        "version": "4.2"
    }



def generate_django_models(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django Models"""
    
    model_name = sanitize_class_name(module['name'])
    
    code = f'''"""
{module['name']} - æ•¸æ“šæ¨¡å‹
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone


class {model_name}(models.Model):
    """
    {module['description']}
    """
    # åŸºç¤å­—æ®µ
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="å‰µå»ºæ™‚é–“")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="æ›´æ–°æ™‚é–“")
    is_active = models.BooleanField(default=True, verbose_name="æ˜¯å¦å•Ÿç”¨")
    
'''
    
    # æ ¹æ“šåŠŸèƒ½æ·»åŠ å­—æ®µ
    if features.get('éœ€è¦ç”¨æˆ¶é—œè¯'):
        code += '''    # ç”¨æˆ¶é—œè¯
    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='%(class)s_set',
        verbose_name="ç”¨æˆ¶"
    )
    
'''
    
    if features.get('éœ€è¦åç¨±'):
        code += '''    # åŸºæœ¬ä¿¡æ¯
    name = models.CharField(max_length=200, verbose_name="åç¨±")
    description = models.TextField(blank=True, verbose_name="æè¿°")
'''
    
    # Financial Precision
    if features.get('use_decimal'):
        code += '    amount = models.DecimalField(max_digits=19, decimal_places=4, default=0, verbose_name="é‡‘é¡")\n'
    else:
        # Default to Decimal for safety even if not explicitly requested
        code += '    amount = models.DecimalField(max_digits=19, decimal_places=4, default=0, verbose_name="é‡‘é¡")\n'
    
    code += '\n'
    
    if features.get('éœ€è¦ç‹€æ…‹'):
        code += '''    # ç‹€æ…‹ç®¡ç†
    STATUS_CHOICES = [
        ('draft', 'è‰ç¨¿'),
        ('active', 'å•Ÿç”¨'),
        ('archived', 'æ­¸æª”'),
    ]
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='draft',
        verbose_name="ç‹€æ…‹"
    )
    
'''
    
    if features.get('use_crypto'):
        code += '''    # å€å¡ŠéˆéŒ¢åŒ…
    wallet_address = models.CharField(max_length=42, unique=True, null=True, blank=True, verbose_name="éŒ¢åŒ…åœ°å€")
    
'''

    code += '''    class Meta:
        verbose_name = "{}"
        verbose_name_plural = "{}åˆ—è¡¨"
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['-created_at']),
        ]
    
    def __str__(self):
        return f"{{self.name if hasattr(self, 'name') else self.id}}"
    
    def save(self, *args, **kwargs):
        """ä¿å­˜å‰çš„é©—è­‰"""
        # æ·»åŠ è‡ªå®šç¾©é©—è­‰é‚è¼¯
        super().save(*args, **kwargs)

# ----------------------------------------
# å€å¡Šéˆå°ˆç”¨æ¨¡å‹ (Auto-Generated by Crypto Module)
# ----------------------------------------
'''.format(model_name, model_name)

    if features.get('use_audit_log'):
        code += '''
# ----------------------------------------
# [å¼·åˆ¶] é†«ç™‚ç´šå¯©è¨ˆæ—¥èªŒ (HIPAA Compliance)
# ----------------------------------------
class AuditLog(models.Model):
    """
    ä¸å¯ç«„æ”¹çš„æ“ä½œæ—¥èªŒ
    """
    action = models.CharField(max_length=50, verbose_name="æ“ä½œé¡å‹")
    user_id = models.IntegerField(verbose_name="æ“ä½œè€…ID") 
    target_id = models.IntegerField(verbose_name="ç›®æ¨™å°è±¡ID")
    ip_address = models.GenericIPAddressField(verbose_name="ä¾†æºIP")
    payload = models.TextField(verbose_name="æ“ä½œå…§å®¹(åŠ å¯†)")
    timestamp = models.DateTimeField(auto_now_add=True)
    hash_signature = models.CharField(max_length=128, verbose_name="é˜²ç«„æ”¹é›œæ¹Š")

    class Meta:
        ordering = ['-timestamp']
        indexes = [models.Index(fields=['timestamp', 'user_id'])]
        
    def save(self, *args, **kwargs):
        # é€™è£¡æ‡‰è©²å¯¦ä½œéˆå¼é›œæ¹Š (Chained Hash) ä»¥é˜²æ­¢åˆªæ”¹
        super().save(*args, **kwargs)

'''

    if features.get('use_ecommerce') or features.get('use_crypto'):
        code += '''
class Product(models.Model):
    name = models.CharField(max_length=200, verbose_name="å•†å“åç¨±")
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="åƒ¹æ ¼")
    stock = models.IntegerField(default=0, verbose_name="åº«å­˜")
    
    def __str__(self):
        return self.name

class Order(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.IntegerField(default=1)
    total_price = models.DecimalField(max_digits=12, decimal_places=2, verbose_name="ç¸½åƒ¹")
    status = models.CharField(max_length=20, default='pending')
    created_at = models.DateTimeField(auto_now_add=True)
'''

    if features.get('use_crypto'):
        code += '''
class Wallet(models.Model):
    address = models.CharField(max_length=42, unique=True, db_index=True, verbose_name="éŒ¢åŒ…åœ°å€")
    balance = models.DecimalField(max_digits=20, decimal_places=8, default=0, verbose_name="é¤˜é¡")
    is_custodial = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)

'''
    return code
    return code


def generate_django_views(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django Views"""
    
    model_name = sanitize_class_name(module['name'])
    
    code = f'''"""
{module['name']} - API è¦–åœ–
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.shortcuts import get_object_or_404

from .models import {model_name}
from .serializers import {model_name}Serializer


class {model_name}ViewSet(viewsets.ModelViewSet):
    """
    {module['description']}
    
    æä¾›æ¨™æº–çš„ CRUD æ“ä½œ:
    - list: ç²å–åˆ—è¡¨
    - create: å‰µå»º
    - retrieve: ç²å–è©³æƒ…
    - update: æ›´æ–°
    - partial_update: éƒ¨åˆ†æ›´æ–°
    - destroy: åˆªé™¤
    """
    queryset = {model_name}.objects.all()
    serializer_class = {model_name}Serializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """
        éæ¿¾æŸ¥è©¢é›†
        åªè¿”å›ç•¶å‰ç”¨æˆ¶çš„æ•¸æ“š
        """
        queryset = super().get_queryset()
        
        # åªè¿”å›å•Ÿç”¨çš„æ•¸æ“š
        queryset = queryset.filter(is_active=True)
        
'''
    
    if features.get('éœ€è¦ç”¨æˆ¶é—œè¯'):
        code += '''        # åªè¿”å›ç•¶å‰ç”¨æˆ¶çš„æ•¸æ“š
        if not self.request.user.is_staff:
            queryset = queryset.filter(user=self.request.user)
        
'''
    
    code += '''        return queryset
    
    def perform_create(self, serializer):
        """å‰µå»ºæ™‚è‡ªå‹•é—œè¯ç”¨æˆ¶"""
'''
    
    if features.get('éœ€è¦ç”¨æˆ¶é—œè¯'):
        code += '''        serializer.save(user=self.request.user)
'''
    else:
        code += '''        serializer.save()
'''
    
    code += '''    
    @action(detail=True, methods=['post'])
    def activate(self, request, pk=None):
        """å•Ÿç”¨"""
        obj = self.get_object()
        obj.is_active = True
        obj.save()
        return Response({'status': 'activated'})
    
    @action(detail=True, methods=['post'])
    def deactivate(self, request, pk=None):
        """åœç”¨"""
        obj = self.get_object()
        obj.is_active = False
        obj.save()
        return Response({'status': 'deactivated'})
'''
    
    return code


def generate_django_serializers(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django Serializers"""
    
    model_name = sanitize_class_name(module['name'])
    
    code = f'''"""
{module['name']} - åºåˆ—åŒ–å™¨
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from rest_framework import serializers
from .models import {model_name}


class {model_name}Serializer(serializers.ModelSerializer):
    """
    {module['description']}åºåˆ—åŒ–å™¨
    """
    
    class Meta:
        model = {model_name}
        fields = '__all__'
        read_only_fields = ['created_at', 'updated_at']
    
    def validate(self, data):
        """
        è‡ªå®šç¾©é©—è­‰
        """
        # æ·»åŠ é©—è­‰é‚è¼¯
        return data
    
    def create(self, validated_data):
        """
        å‰µå»ºå¯¦ä¾‹
        """
        return super().create(validated_data)
    
    def update(self, instance, validated_data):
        """
        æ›´æ–°å¯¦ä¾‹
        """
        return super().update(instance, validated_data)
'''
    
    return code


def generate_django_urls(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django URLs"""
    
    model_name = sanitize_class_name(module['name'])
    app_name = model_name.lower()
    
    code = f'''"""
{module['name']} - URL é…ç½®
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import {model_name}ViewSet

# å‰µå»ºè·¯ç”±å™¨
router = DefaultRouter()
router.register(r'{app_name}', {model_name}ViewSet, basename='{app_name}')

# URL æ¨¡å¼
urlpatterns = [
    path('', include(router.urls)),
]
'''
    
    return code


def generate_django_requirements(features: Dict) -> str:
    """ç”Ÿæˆ Django Requirements"""
    
    requirements = [
        "Django>=4.2.0",
        "djangorestframework>=3.14.0",
        "django-cors-headers>=4.0.0",
        "python-decouple>=3.8",
    ]
    
    if features.get('éœ€è¦èªè­‰'):
        requirements.append("djangorestframework-simplejwt>=5.2.0")
    
    if features.get('éœ€è¦è³‡æ–™åº«'):
        requirements.append("psycopg2-binary>=2.9.0")
    
    if features.get('éœ€è¦å¿«å–'):
        requirements.append("django-redis>=5.2.0")

    if features.get('use_decimal'):
        # For professional money handling
        requirements.append("django-money>=3.2.0")
    
    return '\n'.join(requirements)


def generate_django_admin(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django Admin"""
    
    model_name = sanitize_class_name(module.get('name', 'æ¨¡çµ„'))
    description = module.get('description', 'ç®¡ç†')
    
    code = f'''"""
{module.get('name', 'æ¨¡çµ„')} - Admin é…ç½®
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from django.contrib import admin
from .models import {model_name}


@admin.register({model_name})
class {model_name}Admin(admin.ModelAdmin):
    """
    {description} Admin
    """
    list_display = ['id', 'created_at', 'is_active']
    list_filter = ['is_active', 'created_at']
    search_fields = ['id']
    ordering = ['-created_at']
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {{
            'fields': ('is_active',)
        }}),
        ('æ™‚é–“ä¿¡æ¯', {{
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }}),
    )
    
    readonly_fields = ['created_at', 'updated_at']
'''
    
    return code


def generate_django_tests(module: Dict[str, Any], features: Dict) -> str:
    """ç”Ÿæˆ Django Tests"""
    
    model_name = sanitize_class_name(module['name'])
    
    code = f'''"""
{module['name']} - æ¸¬è©¦
è‡ªå‹•ç”Ÿæˆ by è—åœ–å°è€é¼ 
"""

from django.test import TestCase
from django.contrib.auth.models import User
from rest_framework.test import APIClient
from rest_framework import status

from .models import {model_name}


class {model_name}TestCase(TestCase):
    """
    {module['description']}æ¸¬è©¦
    """
    
    def setUp(self):
        """æ¸¬è©¦å‰æº–å‚™"""
        self.client = APIClient()
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.client.force_authenticate(user=self.user)
    
    def test_create(self):
        """æ¸¬è©¦å‰µå»º"""
        data = {{}}
        response = self.client.post('/api/{model_name.lower()}/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
    
    def test_list(self):
        """æ¸¬è©¦åˆ—è¡¨"""
        response = self.client.get('/api/{model_name.lower()}/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
    
    def test_retrieve(self):
        """æ¸¬è©¦è©³æƒ…"""
        obj = {model_name}.objects.create()
        response = self.client.get(f'/api/{model_name.lower()}/{{obj.id}}/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
    
    def test_update(self):
        """æ¸¬è©¦æ›´æ–°"""
        obj = {model_name}.objects.create()
        data = {{}}
        response = self.client.put(f'/api/{model_name.lower()}/{{obj.id}}/', data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
    
    def test_delete(self):
        """æ¸¬è©¦åˆªé™¤"""
        obj = {model_name}.objects.create()
        response = self.client.delete(f'/api/{model_name.lower()}/{{obj.id}}/')
        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)
'''
    
    return code


def generate_django_setup_instructions() -> str:
    """ç”Ÿæˆ Django å®‰è£èªªæ˜"""
    
    return """
# Django é …ç›®è¨­ç½®èªªæ˜

## 1. å®‰è£ä¾è³´
```bash
pip install -r requirements.txt
```

## 2. é…ç½®æ•¸æ“šåº«
åœ¨ settings.py ä¸­é…ç½®:
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'your_db_name',
        'USER': 'your_db_user',
        'PASSWORD': 'your_db_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

        ## 3. ğŸ¤– AI Agent å–šé†’ (For Cursor / Windsurf / Copilot)
        å¦‚æœæ‚¨ä½¿ç”¨ AI ç·¨è¼¯å™¨ï¼Œè«‹å°‡æ­¤æ–‡ä»¶å¤¾ä¸Ÿå…¥ï¼Œä¸¦è¼¸å…¥ä»¥ä¸‹å’’èª (Prompt) ä¾†å–šé†’å°ˆæ¡ˆï¼š

        > "é€™æ˜¯æˆ‘ç”¨ BlueMouse ç”Ÿæˆçš„ Django å°ˆæ¡ˆæ¶æ§‹ã€‚è«‹è®€å– `models.py` å’Œ `requirements.txt`ã€‚
        > 1. å¹«æˆ‘å®‰è£æ‰€æœ‰ä¾è³´ (pip install)ã€‚
        > 2. åŸ·è¡Œè³‡æ–™åº«é·ç§» (migrate) ä¸¦å•Ÿå‹•ä¼ºæœå™¨ã€‚
        > 3. åŸºæ–¼ `models.py` çš„è©³ç´°è¨»è§£é‚è¼¯ï¼Œå¹«æˆ‘ç”Ÿæˆå°æ‡‰çš„å‰ç«¯ HTML é é¢ (ä½¿ç”¨ Bootstrap 5 æˆ– Tailwind)ã€‚"

        ## 4. é‹è¡Œé·ç§» (Manual)
        ```bash
        python manage.py makemigrations
        python manage.py migrate
        ```

        ## 5. å‰µå»ºè¶…ç´šç”¨æˆ¶
        ```bash
        python manage.py createsuperuser
        ```

        ## 6. é‹è¡Œæœå‹™å™¨
        ```bash
        python manage.py runserver
        ```

        ## 7. è¨ªå• API
        - API æ–‡æª”: http://localhost:8000/api/
        - Admin å¾Œå°: http://localhost:8000/admin/
        """


def parse_user_answers(module: Dict[str, Any], answers: List[int]) -> Dict[str, bool]:
    """
    è§£æç”¨æˆ¶å›ç­”,æå–åŠŸèƒ½éœ€æ±‚
    
    Args:
        module: æ¨¡çµ„è³‡è¨Š
        answers: ç”¨æˆ¶å›ç­”åˆ—è¡¨
        
    Returns:
        åŠŸèƒ½éœ€æ±‚å­—å…¸
    """
    features = {
        'éœ€è¦ç”¨æˆ¶é—œè¯': True,  # é»˜èªéœ€è¦
        'éœ€è¦åç¨±': True,
        'éœ€è¦ç‹€æ…‹': True,
        'éœ€è¦èªè­‰': True,
        'éœ€è¦è³‡æ–™åº«': True,
        'éœ€è¦å¿«å–': False,
    }
    
    # æ ¹æ“šå›ç­”èª¿æ•´åŠŸèƒ½
    # User answers are passed as a list of selected option values (e.g. ['redis_stock', 'pydantic'])
    # Note: The input 'answers' might be indices or values depending on how run_standalone.py passes it.
    # Looking at run_standalone.py: generate_code accepts `answers: Dict[str, str]` (question_id -> option_value)
    
    # But this function signature says `answers: List[int]`. This is legacy.
    # Let's assume run_standalone.py passes a list of VALUES (strings) or we need to update signature.
    # However, let's treat `answers` as a flexible list of values for now.
    
    # Flatten answers if it's a dict, otherwise assume list of values
    selected_values = []
    if isinstance(answers, dict):
        selected_values = list(answers.values())
    elif isinstance(answers, list):
         selected_values = [str(x) for x in answers]

    # Map values to features
    for val in selected_values:
        if val in ['redis', 'redis_stock', 'async_check', 'throttling', 'cache']:
            features['éœ€è¦å¿«å–'] = True
        if val in ['sharding', 'read_write_split']:
            features['éœ€è¦è³‡æ–™åº«'] = True # Enhanced DB
        if val in ['pydantic', 'strict']:
            features['éœ€è¦åš´æ ¼é©—è­‰'] = True
        if val in ['decimal']:
            features['use_decimal'] = True
        if val in ['zero_conf', 'one_conf', 'lightning', 'custodial', 'non_custodial', 'multisig']:
            features['use_crypto'] = True
        
        # Domain Detection
        if val in ['auto_save', 'manual_save', 'manual_review', 'ai_filter']:
            features['use_blog'] = True
        if val in ['first_come', 'waitlist', 'flexible_slot', 'deposit', 'credit_score']:
            features['use_booking'] = True
        if val in ['push_all', 'batch_push', 'infinite_retry', 'background_retry']:
            features['use_chat'] = True
        if val in ['cascade_delete', 'orphan_children', 'last_write_wins', 'manual_merge']:
            features['use_todo'] = True
            
        # Medical Domain Detection
        if val in ['drug', 'prescription', 'medical', 'clinic', 'hospital', 'doctor', 'corp_liable', 'on_prem', 'human_verify']:
            features['use_audit_log'] = True
            
    return features
