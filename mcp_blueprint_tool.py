"""
MCP Server æ•´åˆ - è—åœ–ç”Ÿæˆå·¥å…·
"""

import asyncio
import json

# æ·»åŠ åˆ° server.py çš„å·¥å…·åˆ—è¡¨ä¸­

BLUEPRINT_GENERATION_TOOL = {
    "name": "mmla_generate_blueprint",
    "description": "æ ¹æ“šç”¨æˆ¶çš„è‡ªç„¶èªè¨€è¼¸å…¥ç”Ÿæˆè—åœ–ã€‚ä¾‹å¦‚:'æˆ‘è¦åšä¸€å€‹é›»å•† app'",
    "inputSchema": {
        "type": "object",
        "properties": {
            "user_input": {
                "type": "string",
                "description": "ç”¨æˆ¶çš„éœ€æ±‚æè¿°,ä¾‹å¦‚:'æˆ‘è¦åšä¸€å€‹é›»å•† app åƒè¦çš®'"
            }
        },
        "required": ["user_input"]
    }
}


async def mmla_generate_blueprint_logic(user_input: str) -> str:
    """
    ç”Ÿæˆè—åœ–çš„æ ¸å¿ƒé‚è¼¯
    
    é€™å€‹å‡½æ•¸æœƒ:
    1. æ§‹å»ºæç¤ºè©
    2. èª¿ç”¨ Antigravity çš„ AI
    3. è§£æè¿”å›çš„è—åœ–
    4. è¿”å›çµæ§‹åŒ–çš„ JSON
    """
    
    # æç¤ºè©æ¨¡æ¿
    prompt = f"""ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è»Ÿä»¶æ¶æ§‹å¸«ã€‚ç”¨æˆ¶æœƒå‘Šè¨´ä½ ä»–æƒ³åšä»€éº¼,ä½ è¦å¹«ä»–è¨­è¨ˆè—åœ–ã€‚

ç”¨æˆ¶è¼¸å…¥: {user_input}

è«‹ç”Ÿæˆä¸€å€‹è—åœ–,åŒ…å«:
1. 3-5 å€‹æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„
2. æ¯å€‹æ¨¡çµ„ 1-3 å€‹é—œéµå•é¡Œ
3. æ¯å€‹å•é¡Œ 2-3 å€‹é¸é …

è¼¸å‡ºæ ¼å¼ (JSON):
{{
    "title": "ç”¨æˆ¶éœ€æ±‚çš„æ¨™é¡Œ",
    "cards": [
        {{
            "name": "æ¨¡çµ„åç¨±",
            "questions": [
                {{
                    "text": "å•é¡Œæè¿° (ç”¨æ—¥å¸¸èªè¨€,ä¸è¦æŠ€è¡“è¡“èª)",
                    "options": ["é¸é …1", "é¸é …2", "é¸é …3"],
                    "answer": 0
                }}
            ]
        }}
    ]
}}

é‡è¦:
- å•é¡Œè¦ç”¨æ—¥å¸¸èªè¨€,åƒåœ¨è·Ÿæœ‹å‹èŠå¤©
- é¿å…æŠ€è¡“è¡“èª (å¦‚ã€Œè³‡æ–™åº«é–ã€æ”¹æˆã€Œæœƒä¸æœƒæ¶åˆ°åŒä¸€å€‹å•†å“ã€)
- é¸é …è¦å…·é«”,ä¸è¦æ¨¡ç³Š
- æ¯å€‹æ¨¡çµ„æœ€å¤š 3 å€‹å•é¡Œ

ç¾åœ¨è«‹ç”Ÿæˆè—åœ–:"""
    
    try:
        # èª¿ç”¨ Antigravity çš„ AI
        # æ³¨æ„: é€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›çš„ Antigravity API èª¿æ•´
        
        # æ–¹å¼ 1: å¦‚æœ Antigravity æä¾›äº† generate_text å·¥å…·
        # response = await call_antigravity_tool("generate_text", {"prompt": prompt})
        
        # æ–¹å¼ 2: å¦‚æœåœ¨ Antigravity ç’°å¢ƒä¸­,ç›´æ¥èª¿ç”¨
        # response = await antigravity.ai.generate(prompt)
        
        # æš«æ™‚ä½¿ç”¨æ¨¡æ“¬éŸ¿æ‡‰ (å¯¦éš›éƒ¨ç½²æ™‚æ›¿æ›)
        response = _mock_ai_response(user_input)
        
        # è§£æ JSON
        blueprint = json.loads(response)
        
        # é©—è­‰æ ¼å¼
        if not _validate_blueprint(blueprint):
            raise ValueError("AI ç”Ÿæˆçš„è—åœ–æ ¼å¼ä¸æ­£ç¢º")
        
        return json.dumps({
            "success": True,
            "blueprint": blueprint
        }, ensure_ascii=False)
        
    except Exception as e:
        return json.dumps({
            "success": False,
            "error": str(e),
            "blueprint": _get_fallback_blueprint(user_input)
        }, ensure_ascii=False)


def _mock_ai_response(user_input: str) -> str:
    """æ¨¡æ“¬ AI éŸ¿æ‡‰ (ç”¨æ–¼æ¸¬è©¦)"""
    
    # é›»å•†é¡
    if any(keyword in user_input for keyword in ['é›»å•†', 'è³¼ç‰©', 'è¦çš®', 'æ·˜å¯¶', 'å•†åŸ']):
        return json.dumps({
            "title": "é›»å•† App",
            "cards": [
                {
                    "name": "å•†å“ç®¡ç†",
                    "questions": [
                        {"text": "å•†å“è³£å®Œäº†è¦æ€éº¼é¡¯ç¤º?", "explanation": "ç•¶å•†å“åº«å­˜ç‚º 0 æ™‚,ç³»çµ±éœ€è¦æ±ºå®šå¦‚ä½•é¡¯ç¤ºçµ¦ç”¨æˆ¶", "options": ["é¡¯ç¤ºã€Œå·²å”®å®Œã€", "ç›´æ¥éš±è—", "é¡¯ç¤ºã€Œè£œè²¨ä¸­ã€", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶çŸ¥é“æœ‰é€™å€‹å•†å“\nâš ï¸ å¯èƒ½å½±éŸ¿è³¼è²·æ…¾æœ›", "1": "âœ… é é¢æ›´ç°¡æ½”\nâš ï¸ ç”¨æˆ¶ä¸çŸ¥é“æœ‰é€™å€‹å•†å“", "2": "âœ… ç”¨æˆ¶å¯èƒ½æœƒç­‰å¾…\nâœ… æé«˜å›è³¼ç‡"}},
                        {"text": "å•†å“åœ–ç‰‡è¦å¹¾å¼µ?", "explanation": "æ›´å¤šåœ–ç‰‡å¯ä»¥å±•ç¤ºç´°ç¯€,ä½†æœƒå¢åŠ è¼‰å…¥æ™‚é–“", "options": ["1å¼µä¸»åœ–", "3-5å¼µ", "10å¼µä»¥ä¸Š", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… è¼‰å…¥å¿«é€Ÿ\nâš ï¸ è³‡è¨Šä¸è¶³", "1": "âœ… å¹³è¡¡å±•ç¤ºå’Œé€Ÿåº¦\nâœ… æœ€å¸¸è¦‹çš„é¸æ“‡", "2": "âœ… å±•ç¤ºå®Œæ•´\nâš ï¸ è¼‰å…¥è¼ƒæ…¢"}},
                        {"text": "è¦æ”¯æŒå•†å“è©•åƒ¹å—?", "explanation": "è©•åƒ¹å¯ä»¥å»ºç«‹ä¿¡ä»»,ä½†éœ€è¦å¯©æ ¸æ©Ÿåˆ¶", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… å»ºç«‹ä¿¡ä»»\nâš ï¸ éœ€è¦å¯©æ ¸æ©Ÿåˆ¶", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ ç¼ºå°‘ç¤¾äº¤è­‰æ˜"}},
                        {"text": "å•†å“è¦åˆ†é¡å—?", "explanation": "åˆ†é¡å¯ä»¥å¹«åŠ©ç”¨æˆ¶å¿«é€Ÿæ‰¾åˆ°å•†å“", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶å®¹æ˜“æ‰¾åˆ°\nâš ï¸ éœ€è¦ç¶­è­·åˆ†é¡", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ å•†å“å¤šæ™‚é›£æ‰¾"}},
                        {"text": "è¦æ”¯æŒå•†å“æœå°‹å—?", "explanation": "æœå°‹åŠŸèƒ½å¯ä»¥æé«˜ç”¨æˆ¶é«”é©—", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… å¿«é€Ÿæ‰¾åˆ°å•†å“\nâš ï¸ éœ€è¦æœå°‹å¼•æ“", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ ç”¨æˆ¶é«”é©—å·®"}},
                        {"text": "å•†å“è¦æ”¯æŒè¦æ ¼é¸æ“‡å—?(ä¾‹å¦‚:å°ºå¯¸ã€é¡è‰²)", "explanation": "è¦æ ¼é¸æ“‡å¯ä»¥è®“ä¸€å€‹å•†å“æœ‰å¤šç¨®è®Šé«”", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æ¸›å°‘å•†å“æ•¸é‡\nâš ï¸ åº«å­˜ç®¡ç†è¤‡é›œ", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ å•†å“æ•¸é‡å¤š"}},
                        {"text": "è¦é¡¯ç¤ºå•†å“ç€è¦½æ¬¡æ•¸å—?", "explanation": "ç€è¦½æ¬¡æ•¸å¯ä»¥é¡¯ç¤ºå•†å“ç†±åº¦", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç¤¾äº¤è­‰æ˜\nâš ï¸ éœ€è¦çµ±è¨ˆ", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¦æ”¯æŒå•†å“æ”¶è—å—?", "explanation": "æ”¶è—åŠŸèƒ½å¯ä»¥æé«˜å›è³¼ç‡", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æé«˜å›è³¼ç‡\nâš ï¸ éœ€è¦ç”¨æˆ¶ç™»å…¥", "1": "âœ… é–‹ç™¼ç°¡å–®"}}
                    ]
                },
                {
                    "name": "è³¼ç‰©è»Š",
                    "questions": [
                        {"text": "åŠ å…¥è³¼ç‰©è»Šå¾Œ,å•†å“æ¼²åƒ¹äº†æ€éº¼è¾¦?", "explanation": "åƒ¹æ ¼è®Šå‹•æ™‚,éœ€è¦æ±ºå®šç”¨å“ªå€‹åƒ¹æ ¼çµå¸³", "options": ["ç”¨æ–°åƒ¹æ ¼", "ç”¨èˆŠåƒ¹æ ¼", "é€šçŸ¥ç”¨æˆ¶", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… é¿å…è™§æ\nâš ï¸ ç”¨æˆ¶å¯èƒ½ä¸æ»¿", "1": "âœ… ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ å¯èƒ½è™§æ", "2": "âœ… é€æ˜å…¬å¹³\nâœ… è®“ç”¨æˆ¶æ±ºå®š"}},
                        {"text": "è³¼ç‰©è»Šè¦ä¿å­˜å¤šä¹…?", "explanation": "ä¿å­˜æ™‚é–“å½±éŸ¿ç”¨æˆ¶é«”é©—å’Œè³‡æ–™åº«æˆæœ¬", "options": ["7å¤©", "30å¤©", "æ°¸ä¹…", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç¯€çœç©ºé–“\nâš ï¸ ç”¨æˆ¶å¯èƒ½å¿˜è¨˜", "1": "âœ… å¹³è¡¡é¸æ“‡\nâœ… æœ€å¸¸è¦‹", "2": "âœ… ç”¨æˆ¶é«”é©—æœ€å¥½\nâš ï¸ è³‡æ–™åº«æˆæœ¬é«˜"}},
                        {"text": "è³¼ç‰©è»Šå•†å“æ•¸é‡æœ‰ä¸Šé™å—?", "explanation": "é™åˆ¶æ•¸é‡å¯ä»¥é˜²æ­¢æƒ¡æ„è¡Œç‚º", "options": ["æœ‰,æœ€å¤š10ä»¶", "æœ‰,æœ€å¤š50ä»¶", "æ²’æœ‰é™åˆ¶", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… é˜²æ­¢æƒ¡æ„\nâš ï¸ é™åˆ¶å¤ªåš´", "1": "âœ… å¹³è¡¡é¸æ“‡", "2": "âœ… ç”¨æˆ¶è‡ªç”±\nâš ï¸ å¯èƒ½è¢«æ¿«ç”¨"}},
                        {"text": "è³¼ç‰©è»Šè¦é¡¯ç¤ºç¸½åƒ¹å—?", "explanation": "å³æ™‚é¡¯ç¤ºç¸½åƒ¹å¯ä»¥æé«˜è½‰æ›ç‡", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶æ¸…æ¥šçŸ¥é“\nâœ… æé«˜è½‰æ›ç‡", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¦æ”¯æŒè³¼ç‰©è»Šåˆ†äº«å—?", "explanation": "åˆ†äº«è³¼ç‰©è»Šå¯ä»¥è®“æœ‹å‹å¹«å¿™æŒ‘é¸", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç¤¾äº¤åŠŸèƒ½\nâš ï¸ éœ€è¦ç”Ÿæˆé€£çµ", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è³¼ç‰©è»Šå•†å“ç¼ºè²¨è¦é€šçŸ¥å—?", "explanation": "å³æ™‚é€šçŸ¥å¯ä»¥é¿å…çµå¸³å¤±æ•—", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ éœ€è¦å³æ™‚æª¢æŸ¥", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ çµå¸³æ™‚æ‰ç™¼ç¾"}},
                        {"text": "è¦æ”¯æŒè³¼ç‰©è»Šå„ªæƒ åˆ¸å—?", "explanation": "å„ªæƒ åˆ¸å¯ä»¥æé«˜è½‰æ›ç‡", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æé«˜è½‰æ›ç‡\nâš ï¸ éœ€è¦å„ªæƒ åˆ¸ç³»çµ±", "1": "âœ… é–‹ç™¼ç°¡å–®"}}
                    ]
                },
                {
                    "name": "è¨‚å–®è™•ç†",
                    "questions": [
                        {"text": "åŒæ™‚å¾ˆå¤šäººè²·åŒä¸€å€‹å•†å“,æœƒè¶…è³£å—?", "explanation": "é«˜ä¸¦ç™¼æƒ…æ³ä¸‹,éœ€è¦é˜²æ­¢åº«å­˜è¶…è³£", "options": ["æœƒ,éœ€è¦é˜²æ­¢", "ä¸æœƒ,ç³»çµ±æœƒè™•ç†", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… éœ€è¦åŠ é–æ©Ÿåˆ¶\nâœ… ä¿è­‰ä¸è¶…è³£", "1": "âš ï¸ å¯èƒ½è¶…è³£\nâš ï¸ éœ€è¦é€€æ¬¾"}},
                        {"text": "è¨‚å–®å¯ä»¥å–æ¶ˆå—?", "explanation": "å–æ¶ˆæ”¿ç­–å½±éŸ¿ç”¨æˆ¶é«”é©—å’Œå•†å®¶æ¬Šç›Š", "options": ["éš¨æ™‚å¯ä»¥", "åªèƒ½åœ¨å‡ºè²¨å‰", "ä¸èƒ½å–æ¶ˆ", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ å•†å®¶å¯èƒ½è™§æ", "1": "âœ… å¹³è¡¡é›™æ–¹\nâœ… æœ€å¸¸è¦‹", "2": "âœ… ä¿è­·å•†å®¶\nâš ï¸ ç”¨æˆ¶é«”é©—å·®"}},
                        {"text": "è¨‚å–®è¦ç™¼é€ç¢ºèªéƒµä»¶å—?", "explanation": "ç¢ºèªéƒµä»¶å¯ä»¥è®“ç”¨æˆ¶å®‰å¿ƒ", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶å®‰å¿ƒ\nâš ï¸ éœ€è¦éƒµä»¶ç³»çµ±", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¦æ”¯æŒè¨‚å–®è¿½è¹¤å—?", "explanation": "è¿½è¹¤åŠŸèƒ½å¯ä»¥æ¸›å°‘å®¢æœå£“åŠ›", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æ¸›å°‘å®¢æœ\nâš ï¸ éœ€è¦ç‰©æµ API", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¨‚å–®è¦æ”¯æŒé€€è²¨å—?", "explanation": "é€€è²¨æ”¿ç­–å½±éŸ¿ç”¨æˆ¶ä¿¡ä»»", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… å»ºç«‹ä¿¡ä»»\nâš ï¸ éœ€è¦é€€è²¨æµç¨‹", "1": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ ç”¨æˆ¶ä¸ä¿¡ä»»"}},
                        {"text": "è¦æ”¯æŒè¨‚å–®å‚™è¨»å—?", "explanation": "å‚™è¨»å¯ä»¥è®“ç”¨æˆ¶è£œå……è³‡è¨Š", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ éœ€è¦å¯©æ ¸", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¨‚å–®å®Œæˆå¾Œè¦è©•åƒ¹å—?", "explanation": "è©•åƒ¹å¯ä»¥å»ºç«‹ä¿¡ä»»", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… å»ºç«‹ä¿¡ä»»\nâš ï¸ éœ€è¦è©•åƒ¹ç³»çµ±", "1": "âœ… é–‹ç™¼ç°¡å–®"}}
                    ]
                },
                {
                    "name": "ä»˜æ¬¾",
                    "questions": [
                        {"text": "æ”¯æŒå“ªäº›ä»˜æ¬¾æ–¹å¼?", "explanation": "ä¸åŒçš„ä»˜æ¬¾æ–¹å¼æœƒå½±éŸ¿é–‹ç™¼æˆæœ¬å’Œç”¨æˆ¶é«”é©—", "options": ["åªæœ‰ä¿¡ç”¨å¡", "ä¿¡ç”¨å¡+è¡Œå‹•æ”¯ä»˜", "å…¨éƒ¨éƒ½è¦", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… é–‹ç™¼ç°¡å–®\nâš ï¸ ç”¨æˆ¶é¸æ“‡å°‘", "1": "âœ… å¹³è¡¡é¸æ“‡\nâœ… æ¶µè“‹å¤§éƒ¨åˆ†ç”¨æˆ¶", "2": "âœ… ç”¨æˆ¶é¸æ“‡å¤š\nâš ï¸ é–‹ç™¼æˆæœ¬é«˜"}},
                        {"text": "ä»˜æ¬¾å¤±æ•—è¦é‡è©¦å¹¾æ¬¡?", "explanation": "è‡ªå‹•é‡è©¦å¯ä»¥æé«˜æˆåŠŸç‡,ä½†å¯èƒ½é‡è¤‡æ‰£æ¬¾", "options": ["ä¸é‡è©¦", "é‡è©¦1æ¬¡", "é‡è©¦3æ¬¡", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… é¿å…é‡è¤‡æ‰£æ¬¾\nâš ï¸ æˆåŠŸç‡ä½", "1": "âœ… å¹³è¡¡é¸æ“‡\nâœ… æœ€å®‰å…¨", "2": "âœ… æˆåŠŸç‡é«˜\nâš ï¸ å¯èƒ½é‡è¤‡æ‰£æ¬¾"}},
                        {"text": "è¦æ”¯æŒåˆ†æœŸä»˜æ¬¾å—?", "explanation": "åˆ†æœŸå¯ä»¥æé«˜å¤§é¡å•†å“éŠ·é‡", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æé«˜éŠ·é‡\nâš ï¸ éœ€è¦é‡‘è API", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "è¦æ”¯æŒè²¨åˆ°ä»˜æ¬¾å—?", "explanation": "è²¨åˆ°ä»˜æ¬¾å¯ä»¥æé«˜ä¿¡ä»»", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… æé«˜ä¿¡ä»»\nâš ï¸ éœ€è¦ç‰©æµé…åˆ", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "ä»˜æ¬¾è¦åŠ å¯†å—?", "explanation": "åŠ å¯†å¯ä»¥ä¿è­·ç”¨æˆ¶è³‡æ–™", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ä¿è­·è³‡æ–™\nâœ… å¿…é ˆè¦", "1": "âš ï¸ ä¸å®‰å…¨"}},
                        {"text": "è¦é¡¯ç¤ºä»˜æ¬¾é€²åº¦å—?", "explanation": "é€²åº¦é¡¯ç¤ºå¯ä»¥æ¸›å°‘ç”¨æˆ¶ç„¦æ…®", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶å®‰å¿ƒ", "1": "âœ… é–‹ç™¼ç°¡å–®"}},
                        {"text": "ä»˜æ¬¾å®Œæˆè¦ç™¼é€é€šçŸ¥å—?", "explanation": "é€šçŸ¥å¯ä»¥ç¢ºèªä»˜æ¬¾æˆåŠŸ", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"], "impact": {"0": "âœ… ç”¨æˆ¶å®‰å¿ƒ\nâš ï¸ éœ€è¦é€šçŸ¥ç³»çµ±", "1": "âœ… é–‹ç™¼ç°¡å–®"}}
                    ]
                }
            ]
        }, ensure_ascii=False)
    
    # è¨˜å¸³é¡
    if any(keyword in user_input for keyword in ['è¨˜å¸³', 'å¸³æœ¬', 'èŠ±è²»', 'æ”¯å‡º']):
        return json.dumps({
            "title": "è¨˜å¸³ App",
            "cards": [
                {"name": "è¨˜éŒ„æ”¯å‡º", "questions": [{"text": "æ”¯å‡ºè¦åˆ†é¡å—?", "explanation": "åˆ†é¡å¯ä»¥å¹«åŠ©çµ±è¨ˆ,ä½†æœƒå¢åŠ è¨˜å¸³æ™‚é–“", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}, {"text": "å¯ä»¥æ‹ç™¼ç¥¨ç…§ç‰‡å—?", "explanation": "æ‹ç…§åŠŸèƒ½æ–¹ä¾¿,ä½†éœ€è¦ OCR è­˜åˆ¥æŠ€è¡“", "options": ["å¯ä»¥", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "çµ±è¨ˆå ±è¡¨", "questions": [{"text": "è¦é¡¯ç¤ºåœ–è¡¨å—?", "explanation": "åœ–è¡¨å¯ä»¥æ›´ç›´è§€åœ°çœ‹åˆ°æ”¯å‡ºè¶¨å‹¢", "options": ["è¦åœ“é¤…åœ–", "è¦é•·æ¢åœ–", "éƒ½è¦", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "é ç®—æé†’", "questions": [{"text": "è¶…éé ç®—è¦æé†’å—?", "explanation": "æé†’å¯ä»¥å¹«åŠ©æ§åˆ¶æ”¯å‡º", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}]}
            ]
        }, ensure_ascii=False)
    
    # è‚¡ç¥¨é¡
    if any(keyword in user_input for keyword in ['è‚¡ç¥¨', 'è‚¡å¸‚', 'æŠ•è³‡', 'è­‰åˆ¸']):
        return json.dumps({
            "title": "è‚¡ç¥¨ App",
            "cards": [
                {"name": "å³æ™‚å ±åƒ¹", "questions": [{"text": "è‚¡åƒ¹å¤šä¹…æ›´æ–°ä¸€æ¬¡?", "explanation": "æ›´æ–°é »ç‡æœƒå½±éŸ¿æœå‹™å™¨æˆæœ¬å’Œç”¨æˆ¶é«”é©—", "options": ["æ¯ç§’", "æ¯5ç§’", "æ¯åˆ†é˜", "ğŸ¤· å…ˆè·³é"]}, {"text": "ç¶²è·¯æ–·ç·šæ™‚æ€éº¼è¾¦?", "explanation": "éœ€è¦è™•ç†ç¶²è·¯ä¸ç©©å®šçš„æƒ…æ³", "options": ["é¡¯ç¤ºèˆŠè³‡æ–™", "é¡¯ç¤ºéŒ¯èª¤", "è‡ªå‹•é‡é€£", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "ä¸‹å–®", "questions": [{"text": "ä¸‹å–®å‰è¦ç¢ºèªå—?", "explanation": "ç¢ºèªå¯ä»¥é˜²æ­¢èª¤æ“ä½œ,ä½†æœƒå¤šä¸€å€‹æ­¥é©Ÿ", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "æˆ‘çš„æŒè‚¡", "questions": [{"text": "è¦é¡¯ç¤ºè³ºè³ å¤šå°‘å—?", "explanation": "é¡¯ç¤ºè³ºè³ å¯èƒ½å½±éŸ¿ç”¨æˆ¶å¿ƒæƒ…", "options": ["è¦", "ä¸ç”¨", "è®“ç”¨æˆ¶é¸", "ğŸ¤· å…ˆè·³é"]}]}
            ]
        }, ensure_ascii=False)
    
    # å¤–é€é¡
    if any(keyword in user_input for keyword in ['å¤–é€', 'é€é¤', 'uber', 'foodpanda', 'å«é¤']):
        return json.dumps({
            "title": "å¤–é€å¹³å°",
            "cards": [
                {"name": "é¤å»³åˆ—è¡¨", "questions": [{"text": "è¦é¡¯ç¤ºè·é›¢å—?", "explanation": "è·é›¢å¯ä»¥å¹«åŠ©ç”¨æˆ¶é¸æ“‡,ä½†éœ€è¦å®šä½æ¬Šé™", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}, {"text": "è¦é¡¯ç¤ºè©•åˆ†å—?", "explanation": "è©•åˆ†å¯ä»¥å¹«åŠ©é¸æ“‡,ä½†éœ€è¦è©•åƒ¹ç³»çµ±", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "å³æ™‚è¿½è¹¤", "questions": [{"text": "è¦é¡¯ç¤ºå¤–é€å“¡ä½ç½®å—?", "explanation": "å³æ™‚è¿½è¹¤éœ€è¦ GPS å’Œåœ°åœ– API", "options": ["è¦", "ä¸ç”¨", "ğŸ¤· å…ˆè·³é"]}]},
                {"name": "è¨‚å–®", "questions": [{"text": "å¯ä»¥å–æ¶ˆè¨‚å–®å—?", "explanation": "å–æ¶ˆæ”¿ç­–æœƒå½±éŸ¿ç”¨æˆ¶é«”é©—å’Œå•†å®¶æ¬Šç›Š", "options": ["éš¨æ™‚å¯ä»¥", "åªèƒ½åœ¨æ¥å–®å‰", "ä¸èƒ½å–æ¶ˆ", "ğŸ¤· å…ˆè·³é"]}]}
            ]
        }, ensure_ascii=False)
    
    # é»˜èªéŸ¿æ‡‰
    return json.dumps({
        "title": user_input,
        "cards": [
            {"name": "åŸºæœ¬åŠŸèƒ½", "questions": [{"text": "é€™å€‹åŠŸèƒ½éœ€è¦ç”¨æˆ¶ç™»å…¥å—?", "explanation": "ç™»å…¥å¯ä»¥ä¿å­˜ç”¨æˆ¶æ•¸æ“š,ä½†æœƒå¢åŠ ä½¿ç”¨é–€æª»", "options": ["éœ€è¦", "ä¸éœ€è¦", "ğŸ¤· å…ˆè·³é"]}, {"text": "éœ€è¦ä¿å­˜æ•¸æ“šå—?", "explanation": "ä¿å­˜æ•¸æ“šéœ€è¦è³‡æ–™åº«,ä½†å¯ä»¥è¨˜ä½ç”¨æˆ¶åå¥½", "options": ["éœ€è¦", "ä¸éœ€è¦", "ğŸ¤· å…ˆè·³é"]}]},
            {"name": "ç”¨æˆ¶ç•Œé¢", "questions": [{"text": "éœ€è¦æ·±è‰²æ¨¡å¼å—?", "explanation": "æ·±è‰²æ¨¡å¼å°çœ¼ç›å‹å¥½,ä½†éœ€è¦é¡å¤–è¨­è¨ˆ", "options": ["éœ€è¦", "ä¸éœ€è¦", "ğŸ¤· å…ˆè·³é"]}]}
        ]
    }, ensure_ascii=False)


def _validate_blueprint(blueprint: dict) -> bool:
    """é©—è­‰è—åœ–æ ¼å¼"""
    if "title" not in blueprint or "cards" not in blueprint:
        return False
    
    for card in blueprint["cards"]:
        if "name" not in card or "questions" not in card:
            return False
        
        for question in card["questions"]:
            if "text" not in question or "options" not in question or "answer" not in question:
                return False
    
    return True


def _get_fallback_blueprint(user_input: str) -> dict:
    """ç•¶ AI å¤±æ•—æ™‚çš„å‚™ç”¨è—åœ–"""
    return {
        "title": user_input,
        "cards": [
            {
                "name": "åŸºæœ¬åŠŸèƒ½",
                "questions": [
                    {
                        "text": "é€™å€‹åŠŸèƒ½éœ€è¦ç”¨æˆ¶ç™»å…¥å—?",
                        "options": ["éœ€è¦", "ä¸éœ€è¦"],
                        "answer": 0
                    },
                    {
                        "text": "éœ€è¦ä¿å­˜æ•¸æ“šå—?",
                        "options": ["éœ€è¦", "ä¸éœ€è¦"],
                        "answer": 0
                    }
                ]
            }
        ]
    }


# æ¸¬è©¦å‡½æ•¸
async def test_blueprint_generation():
    """æ¸¬è©¦è—åœ–ç”Ÿæˆ"""
    test_inputs = [
        "æˆ‘è¦åšä¸€å€‹é›»å•† app åƒè¦çš®",
        "æˆ‘è¦åšä¸€å€‹çœ‹è‚¡ç¥¨çš„ app",
        "æˆ‘è¦åšä¸€å€‹è¨˜å¸³ app"
    ]
    
    for user_input in test_inputs:
        print(f"\næ¸¬è©¦è¼¸å…¥: {user_input}")
        result = await mmla_generate_blueprint_logic(user_input)
        print(f"çµæœ: {result}")


if __name__ == "__main__":
    asyncio.run(test_blueprint_generation())
