<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—åœ–å°è€é¼  - Stop Vibe Coding. Start Engineering.</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // ğŸ”§ ç ´å£ä¿®å¾© #2: é…ç½®åŒ–APIç«¯é»
        window.APP_CONFIG = {
            API_URL: 'http://localhost:8001',
            ENABLE_DEBUG: true,
            API_TIMEOUT: 5000,
            // ğŸ†• v5.3 å•†æ¥­åŒ–åŠŸèƒ½
            ENTERPRISE_MODE: false,      // ä¼æ¥­ç‰ˆæ¨¡å¼ï¼ˆä¸è¨˜éŒ„ä»»ä½•æ•¸æ“šï¼‰
            DATA_COLLECTION: true,       // æ•¸æ“šæ”¶é›†é–‹é—œ
            VERSION: '5.3-minimal'       // ç‰ˆæœ¬æ¨™è­˜
        };
    </script>
    <style>
        /* ===== S15 Neumorphism Token System ===== */
        :root {
            /* PANTONE 19-4052 Classic Blue */
            --bg-primary: #E0E5EC;
            --text-primary: #0F4C81;
            --brand-color: #0F4C81;
            --brand-light: #3A7CA5;

            /* S15 æ“¬æ…‹å…‰å½±ç³»çµ± */
            --shadow-raised: 9px 9px 16px rgba(163, 177, 198, 0.6), -9px -9px 16px rgba(255, 255, 255, 0.5);
            --shadow-pressed: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7), inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
            --shadow-floating: 12px 12px 24px 0 rgba(163, 177, 198, 0.6), -12px -12px 24px 0 rgba(255, 255, 255, 0.5);

            /* åœ“è§’ */
            --radius-card: 24px;
            --radius-btn: 50px;

            /* å­—é«” */
            --font-primary: 'Quicksand', sans-serif;

            /* ç‹€æ…‹é¡è‰² */
            --color-locked: #9CA3AF;
            --color-validating: #F59E0B;
            --color-implemented: #10B981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-primary);
            overflow-x: hidden;
        }

        /* ===== Language Switcher (S15 Style) ===== */
        .lang-switcher {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            background: var(--bg-primary);
            border-radius: var(--radius-btn);
            padding: 6px;
            box-shadow: var(--shadow-pressed);
            display: flex;
            gap: 0;
        }

        .lang-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-family: var(--font-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-btn);
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .lang-btn.active {
            background: var(--bg-primary);
            box-shadow: var(--shadow-raised);
            color: var(--brand-color);
        }

        /* ===== Views Container ===== */
        .view {
            min-height: 100vh;
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .view.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }

        /* ===== Landing Page (View A) ===== */
        .landing {
            padding: 80px 20px;
        }

        .hero {
            max-width: 1080px;
            margin: 0 auto 120px;
            text-align: center;
        }

        .hero h1 {
            font-size: 64px;
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 24px;
            color: var(--text-primary);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        }

        .hero p {
            font-size: 24px;
            color: var(--text-primary);
            opacity: 0.8;
            margin-bottom: 48px;
            max-width: 48ch;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-cta {
            padding: 20px 60px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-btn);
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: white;
            cursor: pointer;
            box-shadow: var(--shadow-floating);
            transition: all 0.3s ease;
            font-family: var(--font-primary);
        }

        .hero-cta:hover {
            transform: translateY(-4px);
            box-shadow: 15px 15px 30px rgba(163, 177, 198, 0.7), -15px -15px 30px rgba(255, 255, 255, 0.6);
        }

        .hero-cta:active {
            transform: translateY(0);
            box-shadow: var(--shadow-pressed);
        }

        /* Pain Section */
        .pain-section {
            max-width: 1080px;
            margin: 0 auto 120px;
        }

        .pain-section h2 {
            font-size: 40px;
            text-align: center;
            margin-bottom: 60px;
            color: var(--brand-color);
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .comparison-card {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 40px;
            box-shadow: var(--shadow-raised);
        }

        .comparison-card.bad {
            border-top: 4px solid #EF4444;
        }

        .comparison-card.good {
            border-top: 4px solid var(--color-implemented);
        }

        .comparison-card h3 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .comparison-card ul {
            list-style: none;
            padding: 0;
        }

        .comparison-card li {
            padding: 12px 0;
            padding-left: 30px;
            position: relative;
        }

        .comparison-card.bad li::before {
            content: "âŒ";
            position: absolute;
            left: 0;
        }

        .comparison-card.good li::before {
            content: "âœ…";
            position: absolute;
            left: 0;
        }

        /* Solution Section */
        .solution-section {
            max-width: 1200px;
            margin: 0 auto 120px;
        }

        .solution-section h2 {
            font-size: 40px;
            text-align: center;
            margin-bottom: 60px;
            color: var(--brand-color);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
        }

        .feature-card {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 40px;
            box-shadow: var(--shadow-raised);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-8px);
        }

        .feature-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .feature-card h3 {
            font-size: 24px;
            margin-bottom: 16px;
            color: var(--brand-color);
        }

        .feature-card p {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.8;
        }

        /* Social Proof */
        .proof-section {
            max-width: 1080px;
            margin: 0 auto;
            text-align: center;
            padding: 80px 20px;
        }

        .proof-section h3 {
            font-size: 32px;
            margin-bottom: 40px;
            color: var(--brand-color);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 80px;
        }

        .stat {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 30px 40px;
            box-shadow: var(--shadow-raised);
        }

        .stat-number {
            font-size: 48px;
            font-weight: 600;
            color: var(--brand-color);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 16px;
            opacity: 0.7;
        }

        /* ===== Workspace (View B) ===== */
        .workspace {
            padding: 40px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .workspace-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .workspace-header h1 {
            font-size: 48px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .input-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 40px;
            box-shadow: var(--shadow-raised);
        }

        .input-panel h2 {
            font-size: 24px;
            margin-bottom: 24px;
            color: var(--brand-color);
        }

        .input-neu {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-primary);
            border: none;
            border-radius: 16px;
            font-family: var(--font-primary);
            font-size: 16px;
            color: var(--text-primary);
            box-shadow: var(--shadow-pressed);
            margin-bottom: 20px;
        }

        textarea.input-neu {
            min-height: 150px;
            resize: vertical;
        }

        .traffic-light-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 60px;
            box-shadow: var(--shadow-raised);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .traffic-light {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }

        .light {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: var(--shadow-pressed);
            transition: all 0.3s ease;
        }

        .light.active {
            box-shadow: 0 0 30px;
        }

        .light.red {
            background: #9CA3AF;
        }

        .light.red.active {
            background: #EF4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
        }

        .light.orange {
            background: #9CA3AF;
        }

        .light.orange.active {
            background: #F59E0B;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.8);
            animation: spin 1.5s linear infinite;
        }

        .light.green {
            background: #9CA3AF;
        }

        .light.green.active {
            background: #10B981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .btn-generate {
            padding: 18px 60px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-btn);
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: white;
            cursor: pointer;
            box-shadow: var(--shadow-raised);
            transition: all 0.3s ease;
            font-family: var(--font-primary);
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-3px);
        }

        .btn-generate:active:not(:disabled) {
            box-shadow: var(--shadow-pressed);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 40px;
            box-shadow: var(--shadow-raised);
            display: none;
        }

        .result-panel.active {
            display: block;
        }

        /* ===== Socratic Interview Modal ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 76, 129, 0.3);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-card);
            padding: 48px;
            max-width: 700px;
            width: 90%;
            box-shadow: var(--shadow-floating);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .modal-header h2 {
            font-size: 32px;
            color: var(--brand-color);
            margin-bottom: 12px;
        }

        .modal-header p {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .question-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-raised);
        }

        .question-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .option-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-raised);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option-card:hover {
            transform: translateX(4px);
            border-color: var(--brand-color);
        }

        .option-card.selected {
            border-color: var(--brand-color);
            box-shadow: var(--shadow-pressed);
        }

        .option-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--brand-color);
            margin-bottom: 8px;
        }

        .option-desc {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .option-risk {
            font-size: 12px;
            color: #EF4444;
            font-weight: 600;
            background: rgba(239, 68, 68, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .modal-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .btn-modal {
            padding: 12px 32px;
            border-radius: var(--radius-btn);
            border: none;
            font-family: var(--font-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-raised);
        }

        .btn-modal-primary {
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: white;
            box-shadow: var(--shadow-raised);
        }

        .btn-modal:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {

            .comparison,
            .features-grid {
                grid-template-columns: 1fr;
            }

            .workspace-grid {
                grid-template-columns: 1fr;
            }

            .hero h1 {
                font-size: 40px;
            }

            .modal-content {
                padding: 24px;
            }
        }
    </style>
</head>

<body>
    <!-- Language Switcher -->
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="setLanguage('zh-TW')" id="btn-zh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLanguage('en-US')" id="btn-en">EN</button>
    </div>

    <!-- éœ€æ±‚è¼¸å…¥å€ -->
    <div id="draftNotification"
        style="display: none; padding: 12px; background: #FEF3C7; border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
        ğŸ“ æª¢æ¸¬åˆ°æœªå®Œæˆçš„è‰ç¨¿ï¼Œ<a href="#" onclick="restoreDraft(); return false;"
            style="color: #0F4C81; font-weight: 600;">é»æ“Šæ¢å¾©</a> æˆ– <a href="#" onclick="clearDraft(); return false;"
            style="color: #EF4444;">æ¸…é™¤</a>
    </div>
    <!-- View A: Landing Page -->
    <div id="viewLanding" class="view landing">
        <!-- Hero Section -->
        <section class="hero">
            <h1 data-i18n="hero_title">æ‹’çµ• Vibe Codingï¼Œå¥ªå›é‚è¼¯ä¸»æ¬Š</h1>
            <p data-i18n="hero_subtitle">å…¨çƒå”¯ä¸€å…·å‚™17å±¤é‚è¼¯é©—è­‰çš„AIæ¶æ§‹å¸«ã€‚ä¸äº®ç¶ ç‡ˆï¼Œä¸å‡†ç”Ÿæˆã€‚</p>
            <button class="hero-cta" onclick="enterWorkspace()" data-i18n="cta_start">é–‹å§‹å…è²»è©¦ç”¨</button>
        </section>

        <!-- Pain Section -->
        <section class="pain-section">
            <h2 data-i18n="pain_title">The Pain: ä½ çš„ Copilot æ­£åœ¨ç”¢ç”ŸæŠ€è¡“å‚µ</h2>
            <div class="comparison">
                <div class="comparison-card bad">
                    <h3 data-i18n="other_ai">Other AI ğŸ’©</h3>
                    <ul>
                        <li data-i18n="pain_1">æ†‘æ„Ÿè¦ºç”Ÿæˆä»£ç¢¼</li>
                        <li data-i18n="pain_2">é‚Šç•Œæƒ…æ³å®Œå…¨æ²’è€ƒæ…®</li>
                        <li data-i18n="pain_3">æŠ€è¡“å‚µç‹‚é£†</li>
                        <li data-i18n="pain_4">3å€‹æœˆå¾Œç„¡æ³•ç¶­è­·</li>
                    </ul>
                </div>
                <div class="comparison-card good">
                    <h3 data-i18n="blue_mouse">Blue Mouse ğŸ­âœ¨</h3>
                    <ul>
                        <li data-i18n="solution_1">å¼·åˆ¶é‚è¼¯é©—è­‰</li>
                        <li data-i18n="solution_2">17å±¤åš´æ ¼å¯©æŸ¥</li>
                        <li data-i18n="solution_3">ç´…ç¶ ç‡ˆç‹€æ…‹ç®¡æ§</li>
                        <li data-i18n="solution_4">5å¹´å¾Œä¾ç„¶å¯è®€</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Solution Section -->
        <section class="solution-section">
            <h2 data-i18n="solution_title">The Solution: ä¸‰é“é˜²ç·š</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">ğŸš¦</div>
                    <h3 data-i18n="feature_1_title">Traffic Light Sentinel</h3>
                    <p data-i18n="feature_1_desc">ç´…ç¶ ç‡ˆå“¨å…µå¼·åˆ¶é‚è¼¯æª¢æŸ¥ï¼Œä¾è³´æœªå°±ç·’ï¼Ÿé–æ­»ã€‚</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ“</div>
                    <h3 data-i18n="feature_2_title">Socratic Interview</h3>
                    <p data-i18n="feature_2_desc">è˜‡æ ¼æ‹‰åº•å¼æå•ï¼Œé€¼ä½ æŠŠéœ€æ±‚æƒ³æ¸…æ¥šã€‚</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ›¡ï¸</div>
                    <h3 data-i18n="feature_3_title">17-Layer Validation</h3>
                    <p data-i18n="feature_3_desc">è»è¦ç´šä»£ç¢¼å¯©æŸ¥ï¼Œå¾èªæ³•åˆ°å®‰å…¨å…¨è¦†è“‹ã€‚</p>
                </div>
            </div>
        </section>

        <!-- Social Proof -->
        <section class="proof-section">
            <h3 data-i18n="proof_title">Trusted by Engineers using Cursor & Antigravity</h3>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number">180K+</div>
                    <div class="stat-label" data-i18n="stat_1">æ¬¡é‚è¼¯å¹»è¦ºå·²æ””æˆª</div>
                </div>
                <div class="stat">
                    <div class="stat-number">17</div>
                    <div class="stat-label" data-i18n="stat_2">å±¤é©—è­‰é˜²è­·ç¶²</div>
                </div>
                <div class="stat">
                    <div class="stat-number">100%</div>
                    <div class="stat-label" data-i18n="stat_3">é‚è¼¯å®Œæ•´æ€§ä¿è­‰</div>
                </div>
            </div>
        </section>
    </div>

    <!-- View B: Workspace -->
    <div id="viewWorkspace" class="view workspace hidden">
        <div class="workspace-header">
            <h1 data-i18n="workspace_title">ğŸ­ è—åœ–å°è€é¼  Workspace</h1>
            <p data-i18n="workspace_subtitle">æ™ºèƒ½æ¶æ§‹å·¥ä½œå°</p>
        </div>

        <div class="workspace-grid">
            <!-- Left: Input Panel -->
            <div class="input-panel">
                <h2 data-i18n="input_title">éœ€æ±‚è¼¸å…¥</h2>
                <textarea class="input-neu" id="requirement" placeholder="å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•..."
                    oninput="handleRequirementInput(this)"></textarea>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 13px; color: #6B7280;">
                    <span id="charCount">0 / 5000 å­—</span>
                    <span id="lengthWarning" style="color: #EF4444; display: none;">âš ï¸ è¼¸å…¥éé•·å¯èƒ½å½±éŸ¿æ€§èƒ½</span>
                </div>
                <select class="input-neu" id="framework">
                    <option value="django">Django (Python)</option>
                    <option value="flask">Flask (Python)</option>
                    <option value="fastapi">FastAPI (Python)</option>
                    <option value="express">Express.js (JavaScript)</option>
                    <option value="nestjs">NestJS (TypeScript)</option>
                    <option value="gin">Gin (Go)</option>
                </select>
            </div>

            <!-- Right: Traffic Light Panel -->
            <div class="traffic-light-panel">
                <div class="traffic-light">
                    <div class="light red active" id="lightRed"></div>
                    <div class="light orange" id="lightOrange"></div>
                    <div class="light green" id="lightGreen"></div>
                </div>
                <h3 id="statusText" data-i18n="status_locked">ğŸ”’ ä¾è³´æœªå°±ç·’</h3>
                <button class="btn-generate" onclick="startGeneration()" data-i18n="btn_generate">ç”Ÿæˆè—åœ–</button>
            </div>
        </div>

        <!-- Result Panel -->
        <div class="result-panel" id="resultPanel">
            <h2 data-i18n="result_title">âœ… ç”Ÿæˆå®Œæˆ</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <!-- Socratic Interview Modal -->
    <div class="modal-overlay" id="socratesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="interview_title">ğŸ“ è˜‡æ ¼æ‹‰åº•é‚è¼¯é¢è©¦</h2>
                <p data-i18n="interview_subtitle">åœ¨ç”Ÿæˆä»£ç¢¼å‰ï¼Œè®“æˆ‘å€‘å…ˆæŠŠé‚è¼¯æƒ³æ¸…æ¥š</p>
            </div>
            <div id="questionsContainer"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="skipInterview()"
                    data-i18n="btn_skip">è·³éé¢è©¦</button>
                <button class="btn-modal btn-modal-secondary" onclick="goBackToPrevious()"
                    style="background: #6B7280;">â†©ï¸ ä¸Šä¸€æ­¥</button>
                <button class="btn-modal btn-modal-primary" onclick="submitAnswers()"
                    data-i18n="btn_submit">æäº¤ç­”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <!-- Disconnected Overlay -->
    <div id="disconnectedOverlay" class="modal-overlay" style="z-index: 3000; background: rgba(0,0,0,0.8);">
        <div class="modal-content" style="text-align: center; width: 400px;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”Œ</div>
            <h2 style="color: #EF4444; margin-bottom: 10px;">Server Disconnected</h2>
            <p style="color: var(--text-primary); margin-bottom: 30px;">
                ç„¡æ³•é€£æ¥åˆ°è—åœ–å°è€é¼ å¤§è…¦ (API Server)ã€‚<br>
                è«‹ç¢ºä¿çµ‚ç«¯æ©Ÿä¸­çš„ <b>server.py</b> æ­£åœ¨é‹è¡Œã€‚
            </p>
            <button class="btn-modal btn-modal-primary" onclick="checkHealth()" style="width: 100%;">
                ğŸ”„ å˜—è©¦é‡é€£
            </button>
        </div>
    </div>

    <script>
        // ===== Connection Health Check =====
        let isConnected = true;

        async function checkHealth() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);

                const response = await fetch(`${window.APP_CONFIG.API_URL}/health`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (response.ok) {
                    if (!isConnected) {
                        console.log("âœ… Server reconnected");
                        document.getElementById('disconnectedOverlay').classList.remove('active');
                        isConnected = true;
                    }
                    return true;
                }
            } catch (error) {
                console.log("âŒ Server disconnected");
            }

            // Disconnected flow
            document.getElementById('disconnectedOverlay').classList.add('active');
            isConnected = false;
            return false;
        }

        // Start periodic health check
        setInterval(checkHealth, 5000);
        // Initial check
        checkHealth();

        // ===== i18n Dictionary =====
        const translations = {

            "zh-TW": {
                "hero_title": "æ‹’çµ• Vibe Codingï¼Œå¥ªå›é‚è¼¯ä¸»æ¬Š",
                "hero_subtitle": "å…¨çƒå”¯ä¸€å…·å‚™17å±¤é‚è¼¯é©—è­‰çš„AIæ¶æ§‹å¸«ã€‚ä¸äº®ç¶ ç‡ˆï¼Œä¸å‡†ç”Ÿæˆã€‚",
                "cta_start": "é–‹å§‹å…è²»è©¦ç”¨",
                "pain_title": "The Pain: ä½ çš„ Copilot æ­£åœ¨ç”¢ç”ŸæŠ€è¡“å‚µ",
                "other_ai": "Other AI ğŸ’©",
                "pain_1": "æ†‘æ„Ÿè¦ºç”Ÿæˆä»£ç¢¼",
                "pain_2": "é‚Šç•Œæƒ…æ³å®Œå…¨æ²’è€ƒæ…®",
                "pain_3": "æŠ€è¡“å‚µç‹‚é£†",
                "pain_4": "3å€‹æœˆå¾Œç„¡æ³•ç¶­è­·",
                "blue_mouse": "Blue Mouse ğŸ­âœ¨",
                "solution_1": "å¼·åˆ¶é‚è¼¯é©—è­‰",
                "solution_2": "17å±¤åš´æ ¼å¯©æŸ¥",
                "solution_3": "ç´…ç¶ ç‡ˆç‹€æ…‹ç®¡æ§",
                "solution_4": "5å¹´å¾Œä¾ç„¶å¯è®€",
                "solution_title": "The Solution: ä¸‰é“é˜²ç·š",
                "feature_1_title": "Traffic Light Sentinel",
                "feature_1_desc": "ç´…ç¶ ç‡ˆå“¨å…µå¼·åˆ¶é‚è¼¯æª¢æŸ¥ï¼Œä¾è³´æœªå°±ç·’ï¼Ÿé–æ­»ã€‚",
                "feature_2_title": "Socratic Interview",
                "feature_2_desc": "è˜‡æ ¼æ‹‰åº•å¼æå•ï¼Œé€¼ä½ æŠŠéœ€æ±‚æƒ³æ¸…æ¥šã€‚",
                "feature_3_title": "17-Layer Validation",
                "feature_3_desc": "è»è¦ç´šä»£ç¢¼å¯©æŸ¥ï¼Œå¾èªæ³•åˆ°å®‰å…¨å…¨è¦†è“‹ã€‚",
                "proof_title": "Trusted by Engineers using Cursor & Antigravity",
                "stat_1": "æ¬¡é‚è¼¯å¹»è¦ºå·²æ””æˆª",
                "stat_2": "å±¤é©—è­‰é˜²è­·ç¶²",
                "stat_3": "é‚è¼¯å®Œæ•´æ€§ä¿è­‰",
                "workspace_title": "ğŸ­ è—åœ–å°è€é¼  Workspace",
                "workspace_subtitle": "æ™ºèƒ½æ¶æ§‹å·¥ä½œå°",
                "input_title": "å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•",
                "placeholder_input": "æè¿°æ‚¨æƒ³å»ºç«‹çš„ç³»çµ±ï¼ˆä¾‹å¦‚ï¼šæˆ‘æƒ³åšä¸€å€‹é›»å•†å¹³å°ï¼Œç”¨æˆ¶å¯ä»¥...ï¼‰",
                "status_locked": "ğŸ” å¾…ç¢ºèªç´°ç¯€",
                "status_calibrating": "âš™ï¸ é‚è¼¯æ ¡æº–ä¸­",
                "status_validating": "ğŸ”¬ æ·±åº¦å¥æª¢ä¸­",
                "status_ready": "âœ¨ æº–å‚™å°±ç·’",
                "btn_generate": "é–‹å§‹ç”Ÿæˆ",
                "result_title": "ğŸ‰ æ‚¨çš„å°ˆæ¡ˆå·²å°±ç·’",
                "interview_title": "ğŸ’¡ è®“æˆ‘å€‘å¾®èª¿ä¸€ä¸‹é‚è¼¯",
                "interview_subtitle": "é€™å¹¾å€‹é¸æ“‡æœƒå½±éŸ¿ç³»çµ±ç©©å®šæ€§ï¼Œæ‚¨å‚¾å‘å“ªä¸€ç¨®æ–¹æ¡ˆï¼Ÿ",
                "btn_skip": "ç¨å¾Œæ±ºå®š",
                "btn_submit": "ç¢ºèªé¸æ“‡",
                "hint_completing": "é‚„æœ‰ {count} å€‹é—œéµæ±ºç­–ç­‰æ‚¨ç¢ºèª âœ¨",
                "validating_concurrency": "æ­£åœ¨æª¢æŸ¥ä¸¦ç™¼å®‰å…¨æ€§...",
                "validating_structure": "æ­£åœ¨ç¢ºèªè³‡æ–™åº«çµæ§‹...",
                "validating_security": "æ­£åœ¨æª¢æŸ¥å®‰å…¨æ€§è¨­å®š...",
                "success_message": "é‚è¼¯çœ‹èµ·ä¾†å¾ˆæ£’ï¼éš¨æ™‚å¯ä»¥é–‹å§‹ç”Ÿæˆã€‚"
            },
            "en-US": {
                "hero_title": "Stop Vibe Coding. Start Engineering.",
                "hero_subtitle": "The only AI architect with 17-layer logic validation. No green light, no generation.",
                "cta_start": "Start Free Trial",
                "pain_title": "The Pain: Your Copilot is Creating Tech Debt",
                "other_ai": "Other AI ğŸ’©",
                "pain_1": "Generates code by vibes",
                "pain_2": "Edge cases not considered",
                "pain_3": "Tech debt explosion",
                "pain_4": "Unmaintainable in 3 months",
                "blue_mouse": "Blue Mouse ğŸ­âœ¨",
                "solution_1": "Forced logic validation",
                "solution_2": "17-layer strict review",
                "solution_3": "Traffic light control",
                "solution_4": "Still readable after 5 years",
                "solution_title": "The Solution: Triple Defense",
                "feature_1_title": "Traffic Light Sentinel",
                "feature_1_desc": "Forced logic check. Dependencies not ready? Locked.",
                "feature_2_title": "Socratic Interview",
                "feature_2_desc": "Forces you to think through requirements clearly.",
                "feature_3_title": "17-Layer Validation",
                "feature_3_desc": "Military-grade code review from syntax to security.",
                "proof_title": "Trusted by Engineers using Cursor & Antigravity",
                "stat_1": "Logic hallucinations blocked",
                "stat_2": "Validation layers",
                "stat_3": "Logic integrity guarantee",
                "workspace_title": "ğŸ­ Blue Mouse Workspace",
                "workspace_subtitle": "Intelligent Architecture Console",
                "input_title": "Tell Us Your Vision",
                "placeholder_input": "Describe the system you want to build (e.g., I want an e-commerce platform where users can...)",
                "status_locked": "ğŸ” Needs Clarification",
                "status_calibrating": "âš™ï¸ Calibrating Logic",
                "status_validating": "ğŸ”¬ Running Deep Health Check",
                "status_ready": "âœ¨ Ready to Build",
                "btn_generate": "Start Generation",
                "result_title": "ğŸ‰ Your Project is Ready",
                "interview_title": "ğŸ’¡ Let's Tune the Logic",
                "interview_subtitle": "These choices will affect system stability. Which approach do you prefer?",
                "btn_skip": "Decide Later",
                "btn_submit": "Confirm Choices",
                "hint_completing": "{count} key decisions awaiting your input âœ¨",
                "validating_concurrency": "Checking concurrency safety...",
                "validating_structure": "Verifying database structure...",
                "validating_security": "Checking security settings...",
                "success_message": "Logic looks great! Ready to proceed."
            }
        };

        // currentLang å·²åœ¨å…¨å±€è®Šé‡å€è²æ˜

        // ===== i18n Engine =====
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLanguage', lang);

            // æ›´æ–°æ‰€æœ‰ data-i18n å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(lang === 'zh-TW' ? 'btn-zh' : 'btn-en').classList.add('active');
        }

        // è‡ªå‹•åµæ¸¬èˆ‡åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // ğŸ”§ ç ´å£ä¿®å¾© #1: å…ˆæª¢æŸ¥APIå¯ç”¨æ€§
            await checkAPIHealth();

            // ç„¶å¾Œåˆå§‹åŒ–èªè¨€
            const saved = localStorage.getItem('preferredLanguage');
            const detected = navigator.language.startsWith('zh') ? 'zh-TW' : 'en-US';
            setLanguage(saved || detected);
        });

        // ===== View Transition =====
        function enterWorkspace() {
            document.getElementById('viewLanding').classList.add('hidden');
            document.getElementById('viewWorkspace').classList.remove('hidden');
        }
        // ===== å…¨å±€è®Šé‡ =====
        let currentLang = 'zh-TW';
        let currentQuestions = [];
        let userAnswers = {};
        let answerHistory = []; // å•é¡Œ4ï¼šå›é€€æ©Ÿåˆ¶
        const MAX_INPUT_LENGTH = 5000; // å•é¡Œ5ï¼šé•·åº¦é™åˆ¶

        // ===== å•é¡Œ5ï¼šè¼¸å…¥é•·åº¦é™åˆ¶èˆ‡å­—æ•¸çµ±è¨ˆ =====
        function handleRequirementInput(textarea) {
            const length = textarea.value.length;
            const charCountEl = document.getElementById('charCount');
            const warningEl = document.getElementById('lengthWarning');

            // æ›´æ–°å­—æ•¸çµ±è¨ˆ
            if (charCountEl) {
                charCountEl.textContent = `${length} / ${MAX_INPUT_LENGTH} å­—`;

                if (length > MAX_INPUT_LENGTH) {
                    charCountEl.style.color = '#EF4444';
                    warningEl.style.display = 'inline';
                } else if (length > MAX_INPUT_LENGTH * 0.8) {
                    charCountEl.style.color = '#F59E0B';
                    warningEl.style.display = 'none';
                } else {
                    charCountEl.style.color = '#6B7280';
                    warningEl.style.display = 'none';
                }
            }

            // å•é¡Œ4ï¼šè‡ªå‹•ä¿å­˜è‰ç¨¿
            autoSaveDraft();
        }

        // ===== å•é¡Œ4ï¼šlocalStorage è‰ç¨¿ä¿å­˜ =====
        function autoSaveDraft() {
            const draftData = {
                requirement: document.getElementById('requirement')?.value || '',
                framework: document.getElementById('framework')?.value || 'django',
                timestamp: Date.now()
            };

            try {
                localStorage.setItem('bluemouse_draft', JSON.stringify(draftData));
            } catch (e) {
                console.warn('ç„¡æ³•ä¿å­˜è‰ç¨¿:', e);
            }
        }

        function restoreDraft() {
            try {
                const draft = JSON.parse(localStorage.getItem('bluemouse_draft'));
                if (draft) {
                    const reqEl = document.getElementById('requirement');
                    const fwEl = document.getElementById('framework');

                    if (reqEl) reqEl.value = draft.requirement;
                    if (fwEl) fwEl.value = draft.framework;

                    // æ›´æ–°å­—æ•¸çµ±è¨ˆ
                    handleRequirementInput(reqEl);

                    // éš±è—é€šçŸ¥
                    document.getElementById('draftNotification').style.display = 'none';

                    showToast('âœ… è‰ç¨¿å·²æ¢å¾©');
                }
            } catch (e) {
                console.error('æ¢å¾©è‰ç¨¿å¤±æ•—:', e);
            }
        }

        function clearDraft() {
            localStorage.removeItem('bluemouse_draft');
            document.getElementById('draftNotification').style.display = 'none';
            showToast('ğŸ—‘ï¸ è‰ç¨¿å·²æ¸…é™¤');
        }

        function checkDraftOnLoad() {
            try {
                const draft = JSON.parse(localStorage.getItem('bluemouse_draft'));
                if (draft && draft.requirement) {
                    // æª¢æŸ¥æ˜¯å¦åœ¨24å°æ™‚å…§
                    const age = Date.now() - draft.timestamp;
                    if (age < 24 * 60 * 60 * 1000) {
                        document.getElementById('draftNotification').style.display = 'block';
                    }
                }
            } catch (e) {
                console.warn('æª¢æŸ¥è‰ç¨¿å¤±æ•—:', e);
            }
        }

        // ===== å•é¡Œ3ï¼šå›é€€æ©Ÿåˆ¶ =====
        function saveAnswerToHistory() {
            answerHistory.push({
                questions: [...currentQuestions],
                answers: { ...userAnswers },
                timestamp: Date.now()
            });
        }

        function goBackToPrevious() {
            if (answerHistory.length > 0) {
                const previous = answerHistory.pop();
                currentQuestions = previous.questions;
                userAnswers = previous.answers;

                // é‡æ–°æ¸²æŸ“å•é¡Œ
                showSocratesModal();
                showToast('â†©ï¸ å·²è¿”å›ä¸Šä¸€æ­¥');
            } else {
                showToast('âš ï¸ å·²ç¶“æ˜¯ç¬¬ä¸€æ­¥äº†');
            }
        }

        // ===== å•é¡Œ2ï¼šå‹å¥½éŒ¯èª¤è™•ç† =====
        function handleAPIError(error, context = '') {
            console.error(`APIéŒ¯èª¤ (${context}):`, error);

            let message = '';
            let suggestion = '';

            // ç¶²çµ¡éŒ¯èª¤
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                message = 'ğŸŒ ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨';
                suggestion = 'è«‹ç¢ºèª API Server æ˜¯å¦å·²å•Ÿå‹• (python start_v6.py)';
            }
            // è¶…æ™‚éŒ¯èª¤
            else if (error.message && error.message.includes('timeout')) {
                message = 'â±ï¸ è«‹æ±‚è¶…æ™‚';
                suggestion = 'è«‹å˜—è©¦ç¸®çŸ­éœ€æ±‚æè¿°æˆ–ç¨å¾Œå†è©¦';
            }
            // HTTP éŒ¯èª¤
            else if (error.status) {
                switch (error.status) {
                    case 400:
                        message = 'ğŸ“ è¼¸å…¥æ ¼å¼éŒ¯èª¤';
                        suggestion = 'è«‹æª¢æŸ¥éœ€æ±‚æè¿°æ˜¯å¦å®Œæ•´';
                        break;
                    case 403:
                        message = 'ğŸ”’ è¨ªå•è¢«æ‹’çµ•';
                        suggestion = 'è«‹ç¢ºèªå·²å®Œæˆé‚è¼¯é¢è©¦';
                        break;
                    case 500:
                        message = 'âš™ï¸ æœå‹™å™¨å…§éƒ¨éŒ¯èª¤';
                        suggestion = 'è«‹ç¨å¾Œé‡è©¦æˆ–è¯ç¹«æŠ€è¡“æ”¯æŒ';
                        break;
                    case 503:
                        message = 'ğŸš« æœå‹™æš«æ™‚ä¸å¯ç”¨';
                        suggestion = 'æœå‹™å™¨è² è¼‰éé«˜ï¼Œè«‹ç¨å¾Œé‡è©¦';
                        break;
                    default:
                        message = `âŒ è«‹æ±‚å¤±æ•— (${error.status})`;
                        suggestion = 'è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥';
                }
            }
            // é€šç”¨éŒ¯èª¤
            else {
                message = 'âŒ ç”Ÿæˆå¤±æ•—';
                suggestion = error.message || 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦';
            }

            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤æç¤º
            showErrorDialog(message, suggestion);
        }

        function showErrorDialog(message, suggestion) {
            const errorHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 32px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 400px; z-index: 10000;">
                    <div style="font-size: 48px; text-align: center; margin-bottom: 16px;">ğŸ˜¢</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1F2937;">${message}</div>
                    <div style="font-size: 14px; color: #6B7280; margin-bottom: 24px;">${suggestion}</div>
                    <button onclick="closeErrorDialog()" 
                            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0F4C81, #1E40AF); 
                                   color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
                <div id="errorOverlay" onclick="closeErrorDialog()" 
                     style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999;"></div>
            `;

            const container = document.createElement('div');
            container.id = 'errorDialog';
            container.innerHTML = errorHTML;
            document.body.appendChild(container);
        }

        function closeErrorDialog() {
            const dialog = document.getElementById('errorDialog');
            if (dialog) dialog.remove();
        }

        // ===== Toast é€šçŸ¥å¢å¼· =====
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                padding: 16px 24px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ===== é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è‰ç¨¿ =====
        window.addEventListener('load', () => {
            checkDraftOnLoad();
        });
        // ===== Socratic Interview System =====
        // è®Šé‡å·²åœ¨ä¸Šæ–¹è²æ˜ï¼Œé€™è£¡ä¸å†é‡è¤‡
        let API_AVAILABLE = false;  // ğŸ”§ ç ´å£ä¿®å¾© #1: APIå¯ç”¨æ€§ç‹€æ…‹

        // ğŸ”§ ç ´å£ä¿®å¾© #1: APIå¥åº·æª¢æŸ¥
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${window.APP_CONFIG.API_URL}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(1000)
                });

                if (response.ok) {
                    const data = await response.json();
                    API_AVAILABLE = data.status === 'healthy';

                    if (window.APP_CONFIG.ENABLE_DEBUG) {
                        console.log('âœ… API Server é€£æ¥æˆåŠŸ:', data);
                    }
                } else {
                    API_AVAILABLE = false;
                }
            } catch (error) {
                API_AVAILABLE = false;

                if (window.APP_CONFIG.ENABLE_DEBUG) {
                    console.warn('âš ï¸ API Server æœªé‹è¡Œï¼Œå°‡ä½¿ç”¨é›¢ç·šæ¨¡å¼');
                }
            }

            return API_AVAILABLE;
        }

        async function generateDecisionTraps(requirement) {
            // èª¿ç”¨çœŸå¯¦çš„å¯„ç”ŸAI APIå‹•æ…‹ç”Ÿæˆå•é¡Œ
            try {
                const response = await fetch('http://localhost:8001/api/generate_socratic_questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requirement: requirement,
                        language: currentLang
                    })
                });

                if (!response.ok) {
                    const error = new Error('API call failed');
                    error.status = response.status;
                    throw error;
                }

                const data = await response.json();

                if (data.success && data.questions) {
                    return data.questions;
                } else {
                    throw new Error(data.error || 'å•é¡Œç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                console.error('å¯„ç”ŸAIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨å•é¡Œ:', error);
                // ä½¿ç”¨å‹å¥½éŒ¯èª¤è™•ç†ï¼ˆä½†ä¸é˜»æ–·æµç¨‹ï¼Œä½¿ç”¨å‚™ç”¨ï¼‰
                handleAPIError(error, 'Socratic Questions');
            }

            // å¦‚æœAPIå¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨å›ºå®šå•é¡Œ
            return getFallbackQuestions();
        }

        function getFallbackQuestions() {
            // å‚™ç”¨å›ºå®šå•é¡Œï¼ˆç•¶å¯„ç”ŸAIç„¡æ³•ä½¿ç”¨æ™‚ï¼‰
            const questions = [
                {
                    id: 'q1_concurrency',
                    type: 'single_choice',
                    text: currentLang === 'zh-TW'
                        ? 'é‡å°ã€Œæ•¸æ“šä¸€è‡´æ€§ã€ï¼Œå¦‚æœå¤šå€‹ç”¨æˆ¶åŒæ™‚æ“ä½œæ€éº¼è¾¦ï¼Ÿ'
                        : 'For "data consistency", what if multiple users operate simultaneously?',
                    options: [
                        {
                            label: currentLang === 'zh-TW' ? 'A. æ‚²è§€é– (Pessimistic Lock)' : 'A. Pessimistic Lock',
                            description: currentLang === 'zh-TW'
                                ? 'çµ•å°å®‰å…¨ï¼Œä½†æ•ˆèƒ½æ¥µå·®ï¼Œç”¨æˆ¶å¯èƒ½è¦æ’éšŠç­‰å¾…ã€‚'
                                : 'Absolutely safe, but terrible performance. Users may have to queue.',
                            risk_score: currentLang === 'zh-TW' ? 'ä½é¢¨éšªï¼Œé«˜å»¶é²' : 'Low Risk, High Latency',
                            value: 'pessimistic'
                        },
                        {
                            label: currentLang === 'zh-TW' ? 'B. æ¨‚è§€é– (Optimistic Lock)' : 'B. Optimistic Lock',
                            description: currentLang === 'zh-TW'
                                ? 'æ•ˆèƒ½å¥½ï¼Œä½†åœ¨è¡çªæ™‚æœƒå°è‡´å¤§é‡å¤±æ•—é‡è©¦ã€‚'
                                : 'Good performance, but causes many retry failures on conflict.',
                            risk_score: currentLang === 'zh-TW' ? 'é«˜é¢¨éšªï¼Œä½å»¶é²' : 'High Risk, Low Latency',
                            value: 'optimistic'
                        },
                        {
                            label: currentLang === 'zh-TW' ? 'C. åˆ†æ•£å¼é– (Redis)' : 'C. Distributed Lock (Redis)',
                            description: currentLang === 'zh-TW'
                                ? 'æ¥µå¿«ï¼Œä½†å¦‚æœ Redis æ›äº†æ•¸æ“šæœƒä¸ä¸€è‡´ã€‚'
                                : 'Extremely fast, but data inconsistency if Redis fails.',
                            risk_score: currentLang === 'zh-TW' ? 'æ•¸æ“šä¸€è‡´æ€§é¢¨éšª' : 'Data Consistency Risk',
                            value: 'redis'
                        }
                    ]
                },
                {
                    id: 'q2_error_handling',
                    type: 'single_choice',
                    text: currentLang === 'zh-TW'
                        ? 'å¦‚æœå¤–éƒ¨ API èª¿ç”¨å¤±æ•—ï¼Œç³»çµ±æ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ'
                        : 'If external API call fails, how should the system handle it?',
                    options: [
                        {
                            label: currentLang === 'zh-TW' ? 'A. ç›´æ¥è¿”å›éŒ¯èª¤' : 'A. Return error directly',
                            description: currentLang === 'zh-TW'
                                ? 'ç”¨æˆ¶ç«‹å³çŸ¥é“å¤±æ•—ï¼Œä½†é«”é©—å·®ã€‚'
                                : 'User knows immediately, but poor experience.',
                            risk_score: currentLang === 'zh-TW' ? 'ç”¨æˆ¶é«”é©—å·®' : 'Poor UX',
                            value: 'fail_fast'
                        },
                        {
                            label: currentLang === 'zh-TW' ? 'B. é‡è©¦3æ¬¡' : 'B. Retry 3 times',
                            description: currentLang === 'zh-TW'
                                ? 'å¯èƒ½æˆåŠŸï¼Œä½†æœƒå¢åŠ éŸ¿æ‡‰æ™‚é–“ã€‚'
                                : 'May succeed, but increases response time.',
                            risk_score: currentLang === 'zh-TW' ? 'å»¶é²å¢åŠ ' : 'Increased Latency',
                            value: 'retry'
                        },
                        {
                            label: currentLang === 'zh-TW' ? 'C. é™ç´šè™•ç†' : 'C. Graceful degradation',
                            description: currentLang === 'zh-TW'
                                ? 'ä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆï¼Œä½†åŠŸèƒ½å¯èƒ½ä¸å®Œæ•´ã€‚'
                                : 'Use fallback, but functionality may be incomplete.',
                            risk_score: currentLang === 'zh-TW' ? 'åŠŸèƒ½é™ç´š' : 'Feature Degradation',
                            value: 'degradation'
                        }
                    ]
                }
            ];
            return questions;
        }

        async function showSocratesModal() {
            const requirement = document.getElementById('requirement').value;
            // ğŸš¨ é—œéµä¿®å¾©: æ·»åŠ  await é—œéµå­—
            currentQuestions = await generateDecisionTraps(requirement);
            userAnswers = {};

            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            currentQuestions.forEach((q, qIndex) => {
                const questionHtml = `
                    <div class="question-card">
                        <div class="question-text">${q.text}</div>
                        ${q.options.map((opt, oIndex) => `
                            <div class="option-card" onclick="selectOption('${q.id}', '${opt.value}', this)">
                                <div class="option-label">${opt.label}</div>
                                <div class="option-desc">${opt.description}</div>
                                <div class="option-risk">âš ï¸ ${opt.risk_score}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.innerHTML += questionHtml;
            });

            document.getElementById('socratesModal').classList.add('active');
        }

        function selectOption(questionId, value, element) {
            // æ¸…é™¤åŒä¸€å•é¡Œçš„å…¶ä»–é¸é …
            const parent = element.parentElement;
            parent.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            userAnswers[questionId] = value;
        }

        function skipInterview() {
            document.getElementById('socratesModal').classList.remove('active');
            proceedToGeneration();
        }

        function submitAnswers() {
            if (Object.keys(userAnswers).length < currentQuestions.length) {
                alert(currentLang === 'zh-TW' ? 'è«‹å›ç­”æ‰€æœ‰å•é¡Œ' : 'Please answer all questions');
                return;
            }

            // å•é¡Œ3ï¼šä¿å­˜ç­”æ¡ˆåˆ°æ­·å²ï¼ˆç”¨æ–¼å›é€€ï¼‰
            saveAnswerToHistory();

            document.getElementById('socratesModal').classList.remove('active');
            proceedToGeneration();
        }

        async function proceedToGeneration() {
            // ç‹€æ…‹è½‰æ›: ç´… â†’ æ©˜ (æº«æš–çš„æç¤º)
            document.getElementById('lightRed').classList.remove('active');
            document.getElementById('lightOrange').classList.add('active');
            const validatingMsg = currentLang === 'zh-TW' ? 'ğŸ”¬ æ­£åœ¨ç‚ºæ‚¨é€²è¡Œæ·±åº¦å¥æª¢...' : 'ğŸ”¬ Running Deep Health Check...';
            document.getElementById('statusText').textContent = validatingMsg;

            // é¡¯ç¤ºç´°ç¯€æç¤ºï¼ˆå¾®äº’å‹•ï¼‰
            const steps = [
                currentLang === 'zh-TW' ? 'æ­£åœ¨æª¢æŸ¥ä¸¦ç™¼å®‰å…¨æ€§...' : 'Checking concurrency safety...',
                currentLang === 'zh-TW' ? 'æ­£åœ¨ç¢ºèªè³‡æ–™åº«çµæ§‹...' : 'Verifying database structure...',
                currentLang === 'zh-TW' ? 'æ­£åœ¨æª¢æŸ¥å®‰å…¨æ€§è¨­å®š...' : 'Checking security settings...'
            ];

            for (let step of steps) {
                await sleep(800);
                document.getElementById('statusText').textContent = step;
            }

            // çœŸå¯¦çš„ä»£ç¢¼ç”Ÿæˆ API èª¿ç”¨
            const requirement = document.getElementById('requirement').value;
            const framework = document.getElementById('framework').value;

            try {
                document.getElementById('statusText').textContent = 'âš™ï¸ æ­£åœ¨ç”Ÿæˆä»£ç¢¼...';

                const response = await fetch('http://localhost:8001/api/generate_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module: {
                            name: 'GeneratedModule',
                            description: requirement,
                            functions: []
                        },
                        answers: userAnswers,
                        framework: framework
                    })
                });

                if (!response.ok) {
                    const error = new Error('ä»£ç¢¼ç”Ÿæˆå¤±æ•—');
                    error.status = response.status;
                    throw error;
                }

                const data = await response.json();

                if (data.success) {
                    // å„²å­˜ç”Ÿæˆçš„ä»£ç¢¼ä»¥ä¾›ä¸‹è¼‰
                    window.generatedCode = data.code;

                    // ç‹€æ…‹è½‰æ›: æ©˜ â†’ ç¶  (æº«æš–çš„ç¥è³€)
                    document.getElementById('lightOrange').classList.remove('active');
                    document.getElementById('lightGreen').classList.add('active');
                    const readyMsg = currentLang === 'zh-TW' ? 'âœ… æº–å‚™å°±ç·’ï¼' : 'âœ… Ready to Build!';
                    document.getElementById('statusText').textContent = readyMsg;

                    // ç´™å±‘ç‰¹æ•ˆ
                    if (typeof confetti !== 'undefined') {
                        confetti({
                            particleCount: 150,
                            spread: 80,
                            origin: { y: 0.6 },
                            colors: ['#0F4C81', '#3A7CA5', '#10B981']
                        });
                    }

                    // é¡¯ç¤ºçµæœ
                    showGeneratedResult(data.code);
                } else if (data.gated) {
                    // é–€ç¦é˜»æ“‹
                    document.getElementById('lightOrange').classList.remove('active');
                    document.getElementById('lightRed').classList.add('active');
                    document.getElementById('statusText').textContent = 'ğŸ”’ ' + data.error;

                    // ä½¿ç”¨å‹å¥½éŒ¯èª¤æç¤º
                    const error = new Error(data.message || 'è«‹å…ˆå®Œæˆé‚è¼¯é¢è©¦');
                    error.status = 403;
                    handleAPIError(error, 'Code Generation - Gated');
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±æ•—');
                }

            } catch (error) {
                console.error('ç”Ÿæˆå¤±æ•—:', error);
                document.getElementById('lightOrange').classList.remove('active');
                document.getElementById('lightRed').classList.remove('active');
                document.getElementById('statusText').textContent = 'âŒ ç”Ÿæˆå¤±æ•—';

                // ä½¿ç”¨å‹å¥½éŒ¯èª¤è™•ç†
                handleAPIError(error, 'Code Generation');
            }
        }

        function showGeneratedResult(codeData) {
            // é¡¯ç¤ºçµæœé¢æ¿
            document.getElementById('resultPanel').classList.add('active');

            const fileList = Object.keys(codeData.files || codeData || {});
            const fileCount = fileList.length;

            const successMsg = currentLang === 'zh-TW' ? 'é‚è¼¯çœ‹èµ·ä¾†å¾ˆæ£’ï¼æ‚¨çš„å°ˆæ¡ˆå·²å°±ç·’ã€‚' : 'Logic looks great! Your project is ready.';
            document.getElementById('resultContent').innerHTML = `
                <p style="font-size: 18px; margin-bottom: 20px; color: var(--color-implemented);">
                    ${successMsg}
                </p>
                <p style="font-size: 16px; margin-bottom: 20px;">
                    ${currentLang === 'zh-TW' ? `å·²ç”Ÿæˆ ${fileCount} å€‹æ ¸å¿ƒæ–‡ä»¶` : `Generated ${fileCount} core files`}
                </p>
                <div style="font-size: 14px; color: #666; margin-bottom: 24px;">
                    ${fileList.join(', ')}
                </div>
                <button onclick="downloadProjectZIP()" 
                    style="padding: 16px 40px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    ğŸ“¦ ${currentLang === 'zh-TW' ? 'ä¸‹è¼‰é …ç›® ZIP' : 'Download Project ZIP'}
                </button>
            `;
        }

        async function downloadProjectZIP() {
            if (!window.generatedCode) {
                alert(currentLang === 'zh-TW' ? 'æ²’æœ‰å¯ä¸‹è¼‰çš„ä»£ç¢¼' : 'No code to download');
                return;
            }

            const requirement = document.getElementById('requirement').value;
            const framework = document.getElementById('framework').value;

            try {
                const response = await fetch('http://localhost:8001/api/export_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blueprint: {
                            title: `BlueMouse_${framework}_${Date.now()}`
                        },
                        code: window.generatedCode,
                        diagrams: {},
                        estimation: {}
                    })
                });

                if (!response.ok) {
                    throw new Error('å°å‡ºå¤±æ•—');
                }

                // ä¸‹è¼‰ ZIP æ–‡ä»¶
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BlueMouse_${framework}_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert(currentLang === 'zh-TW' ? 'âœ… é …ç›®å·²ä¸‹è¼‰' : 'âœ… Project downloaded');
            } catch (error) {
                console.error('ä¸‹è¼‰å¤±æ•—:', error);
                alert(currentLang === 'zh-TW' ? 'âŒ ä¸‹è¼‰å¤±æ•—: ' + error.message : 'âŒ Download failed: ' + error.message);
            }
        }

        // ===== Workspace Logic =====
        async function startGeneration() {
            const requirement = document.getElementById('requirement').value;
            const framework = document.getElementById('framework').value;

            if (!requirement.trim()) {
                alert(currentLang === 'zh-TW' ? 'è«‹è¼¸å…¥éœ€æ±‚' : 'Please enter requirement');
                return;
            }

            // è§¸ç™¼è˜‡æ ¼æ‹‰åº•é¢è©¦ (æ·»åŠ  await)
            await showSocratesModal();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>

</html>