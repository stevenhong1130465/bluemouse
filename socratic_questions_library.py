"""
è˜‡æ ¼æ‹‰åº•å¼å•é¡Œåº«
æ”¶é›†é«˜è³ªé‡çš„æ±ºç­–å‹/é‚Šç•Œå‹å•é¡Œç¯„ä¾‹

ğŸš¨ æ ¸å¿ƒä¿®æ­£ 2: Data Trap çš„æ ¸å¿ƒè³‡ç”¢
é€™äº›å•é¡Œç”¨æ–¼æ”¶é›†äººé¡çš„é«˜åƒ¹å€¼æ±ºç­–æ•¸æ“š
"""

from typing import Dict, List, Any

# ========================================
# å•é¡Œåº« - æŒ‰å ´æ™¯åˆ†é¡
# ========================================

QUESTION_LIBRARY: Dict[str, List[Dict[str, Any]]] = {
    
    # ä»˜æ¬¾/äº¤æ˜“å ´æ™¯
    "payment": [
        {
            "text": "å¦‚æœä»˜æ¬¾ API åœ¨æ‰£æ¬¾å¾Œè¶…æ™‚(30ç§’ç„¡éŸ¿æ‡‰),ä½ è¦å¦‚ä½•ç¢ºèªä»˜æ¬¾æ˜¯å¦æˆåŠŸ?",
            "category": "error_handling",
            "options": [
                "A. ç«‹å³é‡è©¦ä»˜æ¬¾è«‹æ±‚ (å¯èƒ½é‡è¤‡æ‰£æ¬¾)",
                "B. èª¿ç”¨æŸ¥è©¢ä»˜æ¬¾ç‹€æ…‹ API (éœ€è¦é¡å¤–æ™‚é–“)",
                "C. æ¨™è¨˜ç‚ºå¾…ç¢ºèª,äººå·¥è™•ç† (å½±éŸ¿ç”¨æˆ¶é«”é©—)"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: å¿«é€Ÿæ¢å¾©\nâš ï¸ é¢¨éšª: å¯èƒ½é‡è¤‡æ‰£æ¬¾,éœ€è¦é€€æ¬¾\nğŸ“Š å½±éŸ¿: ç”¨æˆ¶æŠ•è¨´ç‡ +30%",
                "1": "âœ… å„ªé»: æº–ç¢ºç¢ºèªç‹€æ…‹\nâš ï¸ é¢¨éšª: å¢åŠ éŸ¿æ‡‰æ™‚é–“ 5-10ç§’\nğŸ“Š å½±éŸ¿: ç”¨æˆ¶é«”é©—ä¸‹é™ 10%",
                "2": "âœ… å„ªé»: é›¶é¢¨éšª\nâš ï¸ é¢¨éšª: éœ€è¦äººå·¥ä»‹å…¥,æˆæœ¬é«˜\nğŸ“Š å½±éŸ¿: è¨‚å–®å®Œæˆç‡ -20%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶æ˜¯å¦ç†è§£å†ªç­‰æ€§å’Œåˆ†å¸ƒå¼äº‹å‹™"
        },
        {
            "text": "ç”¨æˆ¶ä»˜æ¬¾æˆåŠŸä½†è¨‚å–®å»ºç«‹å¤±æ•—,ä½ è¦å¦‚ä½•è™•ç†?",
            "category": "recovery",
            "options": [
                "A. è‡ªå‹•é€€æ¬¾çµ¦ç”¨æˆ¶",
                "B. é‡è©¦å»ºç«‹è¨‚å–® (æœ€å¤š3æ¬¡)",
                "C. ä¿ç•™ä»˜æ¬¾è¨˜éŒ„,å…è¨±ç”¨æˆ¶é‡æ–°ä¸‹å–®"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ é¢¨éšª: é€€æ¬¾æ‰‹çºŒè²»,ç”¨æˆ¶å¯èƒ½æµå¤±\nğŸ“Š å½±éŸ¿: è½‰æ›ç‡ -15%",
                "1": "âœ… å„ªé»: è‡ªå‹•æ¢å¾©\nâš ï¸ é¢¨éšª: é‡è©¦å¯èƒ½ä»å¤±æ•—\nğŸ“Š å½±éŸ¿: æˆåŠŸç‡ +60%",
                "2": "âœ… å„ªé»: ä¿ç•™æ”¶å…¥\nâš ï¸ é¢¨éšª: ç”¨æˆ¶å›°æƒ‘,å®¢æœæˆæœ¬é«˜\nğŸ“Š å½±éŸ¿: å®¢æœå·¥å–® +50%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å°è£œå„Ÿäº‹å‹™çš„ç†è§£"
        }
    ],
    
    # åº«å­˜/ä¸¦ç™¼å ´æ™¯
    "inventory": [
        {
            "text": "å…©å€‹ç”¨æˆ¶åŒæ™‚è³¼è²·æœ€å¾Œä¸€ä»¶å•†å“,ä½ è¦å¦‚ä½•è™•ç†?",
            "category": "concurrency",
            "options": [
                "A. å…ˆåˆ°å…ˆå¾—,å¾Œè€…é¡¯ç¤ºå·²å”®å®Œ",
                "B. å…©è€…éƒ½æˆåŠŸ,è¶…è³£å¾Œè£œè²¨",
                "C. ä½¿ç”¨æ¨‚è§€é–,å¤±æ•—è€…è‡ªå‹•é‡è©¦"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: é‚è¼¯ç°¡å–®,ä¸è¶…è³£\nâš ï¸ é¢¨éšª: å¾Œè€…ç”¨æˆ¶é«”é©—å·®\nğŸ“Š å½±éŸ¿: è½‰æ›ç‡ -5%",
                "1": "âœ… å„ªé»: ç”¨æˆ¶é«”é©—å¥½\nâš ï¸ é¢¨éšª: è¶…è³£,è£œè²¨æˆæœ¬é«˜\nğŸ“Š å½±éŸ¿: é‹ç‡Ÿæˆæœ¬ +20%",
                "2": "âœ… å„ªé»: å…¬å¹³ç«¶çˆ­\nâš ï¸ é¢¨éšª: å¯¦ç¾è¤‡é›œ,æ€§èƒ½é–‹éŠ·\nğŸ“Š å½±éŸ¿: éŸ¿æ‡‰æ™‚é–“ +100ms"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å°ä¸¦ç™¼æ§åˆ¶çš„ç†è§£"
        },
        {
            "text": "åº«å­˜æ‰£é™¤æˆåŠŸä½†è¨‚å–®å»ºç«‹å¤±æ•—,ä½ è¦å¦‚ä½•å›æ»¾åº«å­˜?",
            "category": "consistency",
            "options": [
                "A. ç«‹å³å›æ»¾åº«å­˜ +1",
                "B. å»¶é²å›æ»¾ (5åˆ†é˜å¾Œ)",
                "C. ä¸å›æ»¾,å®šæœŸç›¤é»ä¿®æ­£"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: æ•¸æ“šä¸€è‡´æ€§å¥½\nâš ï¸ é¢¨éšª: é«˜ä¸¦ç™¼ä¸‹å¯èƒ½æ­»é–\nğŸ“Š å½±éŸ¿: ç³»çµ±ç©©å®šæ€§ -10%",
                "1": "âœ… å„ªé»: é¿å…ç«¶çˆ­\nâš ï¸ é¢¨éšª: çŸ­æœŸåº«å­˜ä¸æº–\nğŸ“Š å½±éŸ¿: è¶…è³£é¢¨éšª +5%",
                "2": "âœ… å„ªé»: æ€§èƒ½æœ€å„ª\nâš ï¸ é¢¨éšª: æ•¸æ“šä¸ä¸€è‡´\nğŸ“Š å½±éŸ¿: åº«å­˜æº–ç¢ºç‡ -15%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å°äº‹å‹™å›æ»¾çš„ç†è§£"
        }
    ],
    
    # èªè­‰/å®‰å…¨å ´æ™¯
    "authentication": [
        {
            "text": "ç”¨æˆ¶é€£çºŒç™»å…¥å¤±æ•— 5 æ¬¡,ä½ è¦å¦‚ä½•è™•ç†?",
            "category": "security",
            "options": [
                "A. é–å®šå¸³è™Ÿ 30 åˆ†é˜",
                "B. è¦æ±‚åœ–å½¢é©—è­‰ç¢¼",
                "C. ç™¼é€éƒµä»¶é©—è­‰ç¢¼"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: é˜²æ­¢æš´åŠ›ç ´è§£\nâš ï¸ é¢¨éšª: ç”¨æˆ¶å¿˜è¨˜å¯†ç¢¼æ™‚é«”é©—å·®\nğŸ“Š å½±éŸ¿: å®¢æœå·¥å–® +30%",
                "1": "âœ… å„ªé»: å¹³è¡¡å®‰å…¨èˆ‡é«”é©—\nâš ï¸ é¢¨éšª: é©—è­‰ç¢¼å¯èƒ½è¢«ç¹é\nğŸ“Š å½±éŸ¿: å®‰å…¨æ€§ -5%",
                "2": "âœ… å„ªé»: å®‰å…¨æ€§é«˜\nâš ï¸ é¢¨éšª: éƒµä»¶å»¶é²,ç”¨æˆ¶æµå¤±\nğŸ“Š å½±éŸ¿: ç™»å…¥æˆåŠŸç‡ -20%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å°å®‰å…¨èˆ‡é«”é©—çš„å¹³è¡¡"
        }
    ],
    
    # æ•¸æ“š/ä¸€è‡´æ€§å ´æ™¯
    "data_consistency": [
        {
            "text": "ä¸»è³‡æ–™åº«å¯«å…¥æˆåŠŸä½†å¿«å–æ›´æ–°å¤±æ•—,ä½ è¦å¦‚ä½•ä¿è­‰æ•¸æ“šä¸€è‡´æ€§?",
            "category": "consistency",
            "options": [
                "A. å›æ»¾è³‡æ–™åº«å¯«å…¥",
                "B. å¿½ç•¥å¿«å–,ä¸‹æ¬¡è®€å–æ™‚æ›´æ–°",
                "C. é‡è©¦å¿«å–æ›´æ–° (æœ€å¤š3æ¬¡)"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: å¼·ä¸€è‡´æ€§\nâš ï¸ é¢¨éšª: æ€§èƒ½å·®,å¯èƒ½å¤±æ•—\nğŸ“Š å½±éŸ¿: å¯«å…¥æˆåŠŸç‡ -10%",
                "1": "âœ… å„ªé»: æ€§èƒ½å¥½\nâš ï¸ é¢¨éšª: çŸ­æœŸæ•¸æ“šä¸ä¸€è‡´\nğŸ“Š å½±éŸ¿: ç”¨æˆ¶çœ‹åˆ°èˆŠæ•¸æ“š 5-10ç§’",
                "2": "âœ… å„ªé»: å¹³è¡¡æ€§èƒ½èˆ‡ä¸€è‡´æ€§\nâš ï¸ é¢¨éšª: é‡è©¦å¯èƒ½ä»å¤±æ•—\nğŸ“Š å½±éŸ¿: æœ€çµ‚ä¸€è‡´æ€§ 95%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å° CAP å®šç†çš„ç†è§£"
        }
    ],
    
    # API/æœå‹™å ´æ™¯
    "api_integration": [
        {
            "text": "ç¬¬ä¸‰æ–¹ API éŸ¿æ‡‰æ™‚é–“è¶…é 5 ç§’,ä½ è¦å¦‚ä½•è™•ç†?",
            "category": "error_handling",
            "options": [
                "A. ç­‰å¾…ç›´åˆ°è¶…æ™‚ (30ç§’)",
                "B. 5ç§’å¾Œç«‹å³è¿”å›éŒ¯èª¤",
                "C. ä½¿ç”¨å¿«å–çš„èˆŠæ•¸æ“š"
            ],
            "risk_analysis": {
                "0": "âœ… å„ªé»: ä¸ä¸Ÿå¤±è«‹æ±‚\nâš ï¸ é¢¨éšª: ç”¨æˆ¶ç­‰å¾…æ™‚é–“é•·\nğŸ“Š å½±éŸ¿: ç”¨æˆ¶æµå¤±ç‡ +40%",
                "1": "âœ… å„ªé»: å¿«é€Ÿå¤±æ•—\nâš ï¸ é¢¨éšª: åŠŸèƒ½ä¸å¯ç”¨\nğŸ“Š å½±éŸ¿: åŠŸèƒ½å¯ç”¨æ€§ -100%",
                "2": "âœ… å„ªé»: é™ç´šæœå‹™\nâš ï¸ é¢¨éšª: æ•¸æ“šå¯èƒ½éæœŸ\nğŸ“Š å½±éŸ¿: æ•¸æ“šæº–ç¢ºæ€§ -20%"
            },
            "trap": "æ¸¬è©¦ç”¨æˆ¶å°æœå‹™é™ç´šçš„ç†è§£"
        }
    ]
}


# ========================================
# å•é¡Œç”Ÿæˆè¼”åŠ©å‡½æ•¸
# ========================================

def get_questions_by_category(category: str) -> List[Dict[str, Any]]:
    """
    æ ¹æ“šé¡åˆ¥ç²å–å•é¡Œ
    
    Args:
        category: å•é¡Œé¡åˆ¥ (payment, inventory, authentication, etc.)
        
    Returns:
        å•é¡Œåˆ—è¡¨
    """
    return QUESTION_LIBRARY.get(category, [])


def get_random_questions(count: int = 5) -> List[Dict[str, Any]]:
    """
    éš¨æ©Ÿç²å–æŒ‡å®šæ•¸é‡çš„å•é¡Œ
    
    Args:
        count: å•é¡Œæ•¸é‡
        
    Returns:
        å•é¡Œåˆ—è¡¨
    """
    import random
    
    all_questions = []
    for questions in QUESTION_LIBRARY.values():
        all_questions.extend(questions)
    
    return random.sample(all_questions, min(count, len(all_questions)))


def get_questions_for_module(module_name: str, module_description: str) -> List[Dict[str, Any]]:
    """
    æ ¹æ“šæ¨¡çµ„åç¨±å’Œæè¿°æ™ºèƒ½é¸æ“‡å•é¡Œ
    
    Args:
        module_name: æ¨¡çµ„åç¨±
        module_description: æ¨¡çµ„æè¿°
        
    Returns:
        ç›¸é—œå•é¡Œåˆ—è¡¨
    """
    text = (module_name + " " + module_description).lower()
    
    selected_questions = []
    
    # æ ¹æ“šé—œéµè©åŒ¹é…å•é¡Œé¡åˆ¥
    if any(kw in text for kw in ['ä»˜æ¬¾', 'æ”¯ä»˜', 'payment', 'äº¤æ˜“']):
        selected_questions.extend(get_questions_by_category('payment'))
    
    if any(kw in text for kw in ['åº«å­˜', 'inventory', 'å•†å“', 'è³¼ç‰©']):
        selected_questions.extend(get_questions_by_category('inventory'))
    
    if any(kw in text for kw in ['ç™»å…¥', 'èªè­‰', 'auth', 'ç”¨æˆ¶', 'user']):
        selected_questions.extend(get_questions_by_category('authentication'))
    
    if any(kw in text for kw in ['æ•¸æ“š', 'data', 'å¿«å–', 'cache']):
        selected_questions.extend(get_questions_by_category('data_consistency'))
    
    if any(kw in text for kw in ['api', 'æ¥å£', 'ç¬¬ä¸‰æ–¹', 'integration']):
        selected_questions.extend(get_questions_by_category('api_integration'))
    
    # å¦‚æœæ²’æœ‰åŒ¹é…,è¿”å›éš¨æ©Ÿå•é¡Œ
    if not selected_questions:
        selected_questions = get_random_questions(5)
    
    return selected_questions[:5]  # æœ€å¤šè¿”å› 5 å€‹å•é¡Œ


# ========================================
# å•é¡Œè³ªé‡è©•ä¼°
# ========================================

def evaluate_question_quality(question: Dict[str, Any]) -> Dict[str, Any]:
    """
    è©•ä¼°å•é¡Œè³ªé‡
    
    Args:
        question: å•é¡Œå­—å…¸
        
    Returns:
        è©•ä¼°çµæœ
    """
    score = 0
    feedback = []
    
    # æª¢æŸ¥å¿…è¦å­—æ®µ
    required_fields = ['text', 'category', 'options', 'risk_analysis']
    for field in required_fields:
        if field in question:
            score += 25
        else:
            feedback.append(f"ç¼ºå°‘å¿…è¦å­—æ®µ: {field}")
    
    # æª¢æŸ¥é¸é …æ•¸é‡
    if 'options' in question and len(question['options']) >= 3:
        feedback.append("âœ… é¸é …æ•¸é‡å……è¶³")
    else:
        feedback.append("âš ï¸ é¸é …æ•¸é‡ä¸è¶³ (å»ºè­° 3-4 å€‹)")
        score -= 10
    
    # æª¢æŸ¥é¢¨éšªåˆ†æ
    if 'risk_analysis' in question:
        if all(key in question['risk_analysis'] for key in ['0', '1', '2']):
            feedback.append("âœ… é¢¨éšªåˆ†æå®Œæ•´")
        else:
            feedback.append("âš ï¸ é¢¨éšªåˆ†æä¸å®Œæ•´")
            score -= 10
    
    return {
        "score": max(0, score),
        "feedback": feedback,
        "quality": "å„ªç§€" if score >= 90 else "è‰¯å¥½" if score >= 70 else "éœ€æ”¹é€²"
    }


if __name__ == "__main__":
    # æ¸¬è©¦å•é¡Œåº«
    print("=" * 70)
    print("ğŸ§ª è˜‡æ ¼æ‹‰åº•å¼å•é¡Œåº«æ¸¬è©¦")
    print("=" * 70)
    print()
    
    # æ¸¬è©¦å„é¡åˆ¥å•é¡Œæ•¸é‡
    print("ğŸ“Š å•é¡Œåº«çµ±è¨ˆ:")
    total = 0
    for category, questions in QUESTION_LIBRARY.items():
        count = len(questions)
        total += count
        print(f"  - {category:20s}: {count} å€‹å•é¡Œ")
    print(f"\n  ç¸½è¨ˆ: {total} å€‹å•é¡Œ")
    print()
    
    # æ¸¬è©¦æ™ºèƒ½é¸æ“‡
    print("ğŸ¯ æ™ºèƒ½å•é¡Œé¸æ“‡æ¸¬è©¦:")
    test_modules = [
        ("ä»˜æ¬¾ç³»çµ±", "è™•ç†ç”¨æˆ¶ä»˜æ¬¾å’Œè¨‚å–®"),
        ("åº«å­˜ç®¡ç†", "ç®¡ç†å•†å“åº«å­˜"),
        ("ç”¨æˆ¶èªè­‰", "è™•ç†ç”¨æˆ¶ç™»å…¥å’Œæ¬Šé™")
    ]
    
    for name, desc in test_modules:
        questions = get_questions_for_module(name, desc)
        print(f"\n  æ¨¡çµ„: {name}")
        print(f"  åŒ¹é…åˆ° {len(questions)} å€‹å•é¡Œ:")
        for q in questions[:2]:  # åªé¡¯ç¤ºå‰2å€‹
            print(f"    - {q['text'][:50]}...")
    
    print()
    print("âœ… å•é¡Œåº«æ¸¬è©¦å®Œæˆ!")
